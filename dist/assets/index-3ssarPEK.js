var q=Object.defineProperty;var j=(p,e,t)=>e in p?q(p,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):p[e]=t;var r=(p,e,t)=>j(p,typeof e!="symbol"?e+"":e,t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const a of i)if(a.type==="childList")for(const n of a.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&s(n)}).observe(document,{childList:!0,subtree:!0});function t(i){const a={};return i.integrity&&(a.integrity=i.integrity),i.referrerPolicy&&(a.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?a.credentials="include":i.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function s(i){if(i.ep)return;i.ep=!0;const a=t(i);fetch(i.href,a)}})();const M={starting_gold:{id:"starting_gold",name:"åˆæœŸTokenå¢—åŠ ",description:"ã‚²ãƒ¼ãƒ é–‹å§‹æ™‚ã®Token",icon:"ðŸ’°",maxLevel:5,baseCost:100,costMultiplier:1.5,effectPerLevel:10,effectType:"flat"},base_hp:{id:"base_hp",name:"æ‹ ç‚¹HPå¢—åŠ ",description:"æ‹ ç‚¹ã®æœ€å¤§HP",icon:"â¤ï¸",maxLevel:5,baseCost:150,costMultiplier:1.5,effectPerLevel:50,effectType:"flat"},reroll_discount:{id:"reroll_discount",name:"ãƒªãƒ­ãƒ¼ãƒ«å‰²å¼•",description:"ãƒªãƒ­ãƒ¼ãƒ«ã‚³ã‚¹ãƒˆè»½æ¸›",icon:"ðŸ”„",maxLevel:3,baseCost:200,costMultiplier:2,effectPerLevel:10,effectType:"percent"},rare_chance:{id:"rare_chance",name:"ãƒ¬ã‚¢å‡ºç¾çŽ‡UP",description:"ãƒ¬ã‚¢ã‚«ãƒ¼ãƒ‰å‡ºç¾çŽ‡",icon:"âœ¨",maxLevel:5,baseCost:250,costMultiplier:1.8,effectPerLevel:5,effectType:"percent"},tower_damage:{id:"tower_damage",name:"ã‚¿ãƒ¯ãƒ¼æ”»æ’ƒåŠ›UP",description:"å…¨ã‚¿ãƒ¯ãƒ¼ã®åŸºæœ¬æ”»æ’ƒåŠ›",icon:"âš”ï¸",maxLevel:5,baseCost:300,costMultiplier:1.6,effectPerLevel:5,effectType:"percent"},tower_range:{id:"tower_range",name:"ã‚¿ãƒ¯ãƒ¼å°„ç¨‹UP",description:"å…¨ã‚¿ãƒ¯ãƒ¼ã®å°„ç¨‹",icon:"ðŸŽ¯",maxLevel:3,baseCost:350,costMultiplier:2,effectPerLevel:10,effectType:"flat"},elemental_mastery:{id:"elemental_mastery",name:"å±žæ€§ãƒžã‚¹ã‚¿ãƒªãƒ¼",description:"å±žæ€§ã‚¿ãƒ¯ãƒ¼ã®ãƒ€ãƒ¡ãƒ¼ã‚¸",icon:"ðŸ”¥â„ï¸âš¡",maxLevel:5,baseCost:200,costMultiplier:1.7,effectPerLevel:10,effectType:"percent"},start_with_fire:{id:"start_with_fire",name:"ç«ã®æµã¿",description:"åˆæœŸãƒ‡ãƒƒã‚­ã«ç«ã‚¿ãƒ¯ãƒ¼+1",icon:"ðŸ”¥",maxLevel:1,baseCost:300,costMultiplier:1,effectPerLevel:1,effectType:"flat"}},L={MAX_ENTRIES:10},E={STORAGE_KEY:"elemental_deck_defense_progress",XP_PER_WAVE:100,XP_PER_KILL:5,XP_BONUS_MULTIPLIER:1.5,MAX_RANK:10},b=[{rank:1,name:"æ–°ç±³å®ˆè­·è€…",xpRequired:0,unlocks:[]},{rank:2,name:"è¦‹ç¿’ã„é­”è¡“å¸«",xpRequired:500,unlocks:["element_poison","element_light"]},{rank:3,name:"å®ˆå‚™éšŠé•·",xpRequired:1500,unlocks:["map_desert","map_snowfield"]},{rank:4,name:"ç²¾é‹­è¡“å¸«",xpRequired:3e3,unlocks:["feature_reroll_start"]},{rank:5,name:"è¦å¡žæŒ‡æ®å®˜",xpRequired:5e3,unlocks:["starter_fire","starter_ice","starter_lightning"]},{rank:6,name:"å…ƒç´ ã®ä½¿ã„æ‰‹",xpRequired:8e3,unlocks:["map_volcano"]},{rank:7,name:"ä¼èª¬ã®å®ˆè­·è€…",xpRequired:12e3,unlocks:["feature_extra_hand"]},{rank:8,name:"å¤§é­”å°Žå¸«",xpRequired:17e3,unlocks:["element_arcane"]},{rank:9,name:"ä¸æ»…ã®è‹±é›„",xpRequired:25e3,unlocks:["feature_starting_bonus"]},{rank:10,name:"ä¸–ç•Œã®å®ˆè­·ç¥ž",xpRequired:4e4,unlocks:["feature_master_mode"]}],I={element_poison:{id:"element_poison",name:"æ¯’å±žæ€§",description:"æ•µã«ç¶™ç¶šãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’ä¸Žãˆã‚‹æ¯’ã‚¿ãƒ¯ãƒ¼",icon:"â˜ ï¸",requiredRank:2,type:"element",unlockData:"poison"},element_light:{id:"element_light",name:"å…‰å±žæ€§",description:"åºƒç¯„å›²ã‚’ç…§ã‚‰ã—æ•µã‚’æ¸›é€Ÿã•ã›ã‚‹å…‰ã‚¿ãƒ¯ãƒ¼",icon:"âœ¨",requiredRank:2,type:"element",unlockData:"light"},element_arcane:{id:"element_arcane",name:"ç§˜è¡“å±žæ€§",description:"å…¨å±žæ€§ã®åŠ›ã‚’å®¿ã™ç©¶æ¥µã®ã‚¿ãƒ¯ãƒ¼",icon:"ðŸ”®",requiredRank:8,type:"element",unlockData:"arcane"},map_desert:{id:"map_desert",name:"ç ‚æ¼ ãƒžãƒƒãƒ—",description:"åºƒå¤§ãªç ‚æ¼ ã§ã®æˆ¦ã„",icon:"ðŸœï¸",requiredRank:3,type:"map",unlockData:"desert"},map_snowfield:{id:"map_snowfield",name:"é›ªåŽŸãƒžãƒƒãƒ—",description:"å‡ã¦ã¤ãé›ªåŽŸã§ã®æˆ¦ã„",icon:"â„ï¸",requiredRank:3,type:"map",unlockData:"snowfield"},map_volcano:{id:"map_volcano",name:"ç«å±±ãƒžãƒƒãƒ—",description:"ç¼ç†±ã®ç«å±±ã§ã®æˆ¦ã„",icon:"ðŸŒ‹",requiredRank:6,type:"map",unlockData:"volcano"},starter_fire:{id:"starter_fire",name:"ç‚Žã®ãƒ‡ãƒƒã‚­",description:"ç«å±žæ€§ã«ç‰¹åŒ–ã—ãŸåˆæœŸãƒ‡ãƒƒã‚­",icon:"ðŸ”¥",requiredRank:5,type:"starter_deck",unlockData:"fire"},starter_ice:{id:"starter_ice",name:"æ°·ã®ãƒ‡ãƒƒã‚­",description:"æ°·å±žæ€§ã«ç‰¹åŒ–ã—ãŸåˆæœŸãƒ‡ãƒƒã‚­",icon:"â„ï¸",requiredRank:5,type:"starter_deck",unlockData:"ice"},starter_lightning:{id:"starter_lightning",name:"é›·ã®ãƒ‡ãƒƒã‚­",description:"é›·å±žæ€§ã«ç‰¹åŒ–ã—ãŸåˆæœŸãƒ‡ãƒƒã‚­",icon:"âš¡",requiredRank:5,type:"starter_deck",unlockData:"lightning"},feature_reroll_start:{id:"feature_reroll_start",name:"é–‹å§‹æ™‚ãƒªãƒ­ãƒ¼ãƒ«",description:"ã‚²ãƒ¼ãƒ é–‹å§‹æ™‚ã«æ‰‹æœ­ã‚’ãƒªãƒ­ãƒ¼ãƒ«å¯èƒ½",icon:"ðŸ”„",requiredRank:4,type:"feature"},feature_extra_hand:{id:"feature_extra_hand",name:"åˆæœŸæ‰‹æœ­+1",description:"åˆæœŸæ‰‹æœ­ã‚µã‚¤ã‚ºãŒ+1",icon:"ðŸƒ",requiredRank:7,type:"feature"},feature_starting_bonus:{id:"feature_starting_bonus",name:"åˆæœŸãƒœãƒ¼ãƒŠã‚¹",description:"ã‚²ãƒ¼ãƒ é–‹å§‹æ™‚ã«50 Tokenç²å¾—",icon:"ðŸ’°",requiredRank:9,type:"feature"},feature_master_mode:{id:"feature_master_mode",name:"ãƒžã‚¹ã‚¿ãƒ¼ãƒ¢ãƒ¼ãƒ‰",description:"è¶…é«˜é›£æ˜“åº¦ãƒ¢ãƒ¼ãƒ‰ãŒè§£æ”¾",icon:"ðŸ’€",requiredRank:10,type:"feature"}},S={INITIAL_TOKENS:0,WAVE_CLEAR_BONUS:50,ENEMY_DROP_CHANCE:.1,ENEMY_DROP_AMOUNT:5,INTEREST_RATE:.1,MAX_INTEREST:30,SHOP_REROLL_COST:10,SHOP_ITEMS_COUNT:4,ENEMIES_PER_CARD_REFILL:5,RECYCLE_TOKEN_BASE:10},K={new_card:50,hand_size_up:150,reroll_token:30,base_repair:20,artifact:200,tower_upgrade:80,expansion_pack:120,vip_membership:180,recycle_bin:100},B={fire_damage_up:{name:"ç‚Žã®å°ç« ",description:"ç«å±žæ€§ãƒ€ãƒ¡ãƒ¼ã‚¸+25%",icon:"ðŸ”¥",value:.25},ice_damage_up:{name:"æ°·ã®å°ç« ",description:"æ°·å±žæ€§ãƒ€ãƒ¡ãƒ¼ã‚¸+25%",icon:"â„ï¸",value:.25},lightning_damage_up:{name:"é›·ã®å°ç« ",description:"é›·å±žæ€§ãƒ€ãƒ¡ãƒ¼ã‚¸+25%",icon:"âš¡",value:.25},all_damage_up:{name:"æˆ¦ç¥žã®åŠ è­·",description:"å…¨ãƒ€ãƒ¡ãƒ¼ã‚¸+15%",icon:"âš”ï¸",value:.15},tower_hp_up:{name:"é‰„å£ã®å®ˆã‚Š",description:"ã‚¿ãƒ¯ãƒ¼HP+50%",icon:"ðŸ›¡ï¸",value:.5},expansion_pack:{name:"æ‹¡å¼µãƒ‘ãƒƒã‚¯",description:"ã‚·ãƒ§ãƒƒãƒ—é¸æŠžè‚¢+1",icon:"ðŸ“¦",value:1},vip_membership:{name:"VIPãƒ¡ãƒ³ãƒãƒ¼ã‚·ãƒƒãƒ—",description:"ãƒ¬ã‚¢å‡ºç¾çŽ‡+15%",icon:"ðŸ‘‘",value:.15},recycle_bin:{name:"ãƒªã‚µã‚¤ã‚¯ãƒ«ãƒ“ãƒ³",description:"ã‚«ãƒ¼ãƒ‰ç ´æ£„æ™‚Tokenç²å¾—",icon:"â™»ï¸",value:1},interest_rate_up:{name:"å•†äººã®çŸ¥æµ",description:"åˆ©å­çŽ‡+5%",icon:"ðŸ’°",value:.05}},z=["physical","fire","ice","lightning"],P={melt:{name:"MELT!",description:"èžè§£: å¤§ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’ä¸Žãˆã‚‹",trigger:["ice","fire"],icon:"ðŸ’§ðŸ”¥",color:"#ff9800",damageMultiplier:3},freeze:{name:"FREEZE!",description:"å‡çµ: 2ç§’é–“å‹•ãã‚’æ­¢ã‚ã‚‹",trigger:["ice","lightning"],icon:"â„ï¸âš¡",color:"#00bcd4",freezeDuration:2e3},explosion:{name:"EXPLOSION!",description:"çˆ†ç™º: å‘¨å›²ã«ãƒ€ãƒ¡ãƒ¼ã‚¸",trigger:["oil","fire"],icon:"ðŸ’¥",color:"#ff5722",damageMultiplier:1.5,explosionRadius:80}},w={meteor:{name:"ãƒ¡ãƒ†ã‚ª",description:"æŒ‡å®šç¯„å›²ã«å¤§ãƒ€ãƒ¡ãƒ¼ã‚¸",icon:"â˜„ï¸",color:"#e74c3c",borderColor:"#c0392b",radius:60,damage:200,cooldown:2},blizzard:{name:"ãƒ–ãƒªã‚¶ãƒ¼ãƒ‰",description:"å…¨ä½“ã‚’3ç§’é–“æ¸›é€Ÿ",icon:"ðŸŒ¨ï¸",color:"#3498db",borderColor:"#2980b9",radius:9999,slowDuration:3e3,slowMultiplier:.4,appliesStatus:"ice",cooldown:1},oil_bomb:{name:"ã‚ªã‚¤ãƒ«ãƒœãƒ ",description:"ç¯„å›²ã«ã‚ªã‚¤ãƒ«çŠ¶æ…‹ã‚’ä»˜ä¸Ž",icon:"ðŸ›¢ï¸",color:"#6b4423",borderColor:"#3d2817",radius:70,damage:30,appliesStatus:"oil",cooldown:3}},T={physical:{name:"ç‰©ç†",color:"#7f8c8d",borderColor:"#5d6d7e",projectileColor:"#95a5a6",icon:"ðŸ¹"},fire:{name:"ç«",color:"#e74c3c",borderColor:"#c0392b",projectileColor:"#ff6b4a",icon:"ðŸ”¥"},ice:{name:"æ°·",color:"#3498db",borderColor:"#2980b9",projectileColor:"#74b9ff",icon:"â„ï¸"},lightning:{name:"é›·",color:"#f1c40f",borderColor:"#d4a800",projectileColor:"#fff176",icon:"âš¡"},poison:{name:"æ¯’",color:"#27ae60",borderColor:"#1e8449",projectileColor:"#58d68d",icon:"â˜ ï¸"},light:{name:"å…‰",color:"#f8e71c",borderColor:"#d4c100",projectileColor:"#fff9c4",icon:"âœ¨"},arcane:{name:"ç§˜è¡“",color:"#9b59b6",borderColor:"#7d3c98",projectileColor:"#bb8fce",icon:"ðŸ”®"}},X={1:1,2:.8,3:.6},Y={1:0,2:4,3:8},Z={fire_ice:{name:"è’¸æ°—çˆ†ç™º",description:"ç«ã®æ”»æ’ƒåŠ›2å€",sourceElement:"fire",requiredElement:"ice",damageMultiplier:2,icon:"ðŸ’¨"},ice_lightning:{name:"å‡çµé›·æ’ƒ",description:"æ°·ã®æ”»æ’ƒåŠ›1.5å€",sourceElement:"ice",requiredElement:"lightning",damageMultiplier:1.5,icon:"âš¡â„ï¸"},lightning_fire:{name:"ç‚Žé›·",description:"é›·ã®æ”»æ’ƒåŠ›1.5å€",sourceElement:"lightning",requiredElement:"fire",damageMultiplier:1.5,icon:"ðŸ”¥âš¡"}},A=3,V={normal:{name:"é€šå¸¸",baseHealth:80,baseSpeed:1.5,size:24,color:"#e74c3c",attackDamage:5,attackCooldown:2e3,evasionChance:0,priority:1,ignoresPath:!1,targetsNearestTower:!1,icon:"ðŸ‘¹"},tank:{name:"ã‚¿ãƒ³ã‚¯",baseHealth:250,baseSpeed:.8,size:32,color:"#8e44ad",attackDamage:15,attackCooldown:3e3,evasionChance:0,priority:3,ignoresPath:!1,targetsNearestTower:!1,icon:"ðŸ›¡ï¸"},breaker:{name:"ãƒ–ãƒ¬ã‚¤ã‚«ãƒ¼",baseHealth:40,baseSpeed:2,size:22,color:"#e67e22",attackDamage:80,attackCooldown:500,evasionChance:0,priority:2,ignoresPath:!1,targetsNearestTower:!0,icon:"ðŸ’£"},ghost:{name:"ã‚´ãƒ¼ã‚¹ãƒˆ",baseHealth:60,baseSpeed:1.2,size:26,color:"#9b59b6",attackDamage:8,attackCooldown:2500,evasionChance:.5,priority:1,ignoresPath:!0,targetsNearestTower:!1,icon:"ðŸ‘»"},boss:{name:"ãƒœã‚¹",baseHealth:2e3,baseSpeed:.5,size:60,color:"#c0392b",attackDamage:30,attackCooldown:4e3,evasionChance:0,priority:5,ignoresPath:!1,targetsNearestTower:!1,icon:"ðŸ‘‘",isBoss:!0,ccImmunity:.8,skillCooldown:5e3}},g={CANVAS_WIDTH:600,CANVAS_HEIGHT:600,GRID_SIZE:40,GRID_COLS:15,GRID_ROWS:15,BASE_ROW:7,BASE_COL:7,PATH_COLOR:"#2a2a3d",GRID_COLOR:"#1f1f2e",BACKGROUND_COLOR:"#12121a",BASE_COLOR:"#4a90d9"},O={0:"#e74c3c",1:"#9b59b6",2:"#27ae60",3:"#e67e22"},J={physical:40,fire:28,ice:28,lightning:28,poison:28,light:28,arcane:28},x=(p,e=1)=>{const t=J[p];return{element:p,range:120+(e-1)*20,fireRate:Math.max(500,1e3-(e-1)*200),damage:t*e,size:30+Y[e]}};x("physical");const C={CARD_WIDTH:100,CARD_HEIGHT:140,HAND_SIZE:3,MAX_HAND_SIZE:7,SPELL_CHANCE:.3},Q={speed:8,size:6,color:"#f1c40f",damage:50},H={physical:{element:"physical",name:"å¼“çŸ¢ã‚¿ãƒ¯ãƒ¼",icon:"ðŸ¹",color:"#7f8c8d",description:"ç‰¹æ®ŠåŠ¹æžœã‚’æŒãŸãªã„ã‚·ãƒ³ãƒ—ãƒ«ãªã‚¿ãƒ¯ãƒ¼ã€‚å®‰å®šã—ãŸãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’ä¸Žãˆã‚‹ã€‚",flavorText:"ã€Œæ´¾æ‰‹ã•ã¯ãªã„ãŒã€ç¢ºå®Ÿã«ä»•äº‹ã‚’ã“ãªã™ã€ - è¡›å…µé•·ãƒžãƒ¼ã‚«ã‚¹",baseStats:{damage:40,range:120,fireRate:1e3}},fire:{element:"fire",name:"ç‚Žã®ã‚¿ãƒ¯ãƒ¼",icon:"ðŸ”¥",color:"#e74c3c",description:"æ•µã«ç‚Žå±žæ€§ã‚’ä»˜ä¸Žã™ã‚‹ã‚¿ãƒ¯ãƒ¼ã€‚æ°·ã¨ã®èžè§£åå¿œã§å¤§ãƒ€ãƒ¡ãƒ¼ã‚¸ã€‚",flavorText:"ã€Œç‡ƒãˆä¸ŠãŒã‚Œã€æˆ‘ãŒé­‚ã‚ˆï¼ã€ - ç«ç‚Žè¡“å¸«ã‚¸ã‚§ã‚¤ã‚¯",baseStats:{damage:28,range:120,fireRate:1e3}},ice:{element:"ice",name:"æ°·ã®ã‚¿ãƒ¯ãƒ¼",icon:"â„ï¸",color:"#3498db",description:"æ”»æ’ƒã—ãŸæ•µã‚’æ¸›é€Ÿã•ã›ã‚‹ã‚¿ãƒ¯ãƒ¼ã€‚ç«ã¨ã®èžè§£ã€é›·ã¨ã®å‡çµåå¿œã€‚",flavorText:"ã€Œæ°¸ä¹…å‡åœŸã®åŠ›ã€ä»Šã“ã“ã«ã€ - æ°·çµå¸«ã‚¨ãƒ¬ãƒŠ",baseStats:{damage:28,range:130,fireRate:1100}},lightning:{element:"lightning",name:"é›·ã®ã‚¿ãƒ¯ãƒ¼",icon:"âš¡",color:"#f1c40f",description:"é«˜é€Ÿã§æ”»æ’ƒã™ã‚‹ã‚¿ãƒ¯ãƒ¼ã€‚æ°·ã¨ã®å‡çµåå¿œã§æ•µã‚’å®Œå…¨åœæ­¢ã€‚",flavorText:"ã€Œç¨²å¦»ã®å¦‚ãé€Ÿãã€é›·é³´ã®å¦‚ãå¼·ãã€ - é›·æ’ƒå¸«ãƒœãƒ«ãƒˆ",baseStats:{damage:28,range:110,fireRate:700}},poison:{element:"poison",name:"æ¯’ã®ã‚¿ãƒ¯ãƒ¼",icon:"â˜ ï¸",color:"#27ae60",description:"æ•µã«ç¶™ç¶šãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’ä¸Žãˆã‚‹æ¯’çŠ¶æ…‹ã‚’ä»˜ä¸Žã™ã‚‹ã‚¿ãƒ¯ãƒ¼ã€‚",flavorText:"ã€Œä¸€æ»´ã§ã‚‚è§¦ã‚Œã‚Œã°ã€å‘½ã¯è•ã¾ã‚Œã‚‹ã€ - æ¯’è¡“å¸«ãƒ´ã‚§ãƒŽãƒ ",baseStats:{damage:30,range:100,fireRate:1200}},light:{element:"light",name:"å…‰ã®ã‚¿ãƒ¯ãƒ¼",icon:"âœ¨",color:"#f8e71c",description:"åºƒç¯„å›²ã®æ•µã‚’ç…§ã‚‰ã—ã¦æ¸›é€Ÿã•ã›ã‚‹ã‚¿ãƒ¯ãƒ¼ã€‚",flavorText:"ã€Œé—‡ã‚’æ‰•ã„ã€é“ã‚’ç…§ã‚‰ã™ã€ - è–å…‰å¸«ãƒ«ãƒŸãƒŠ",baseStats:{damage:25,range:150,fireRate:1e3}},arcane:{element:"arcane",name:"ç§˜è¡“ã®ã‚¿ãƒ¯ãƒ¼",icon:"ðŸ”®",color:"#9b59b6",description:"å…¨å±žæ€§ã®åŠ›ã‚’å®¿ã™ç©¶æ¥µã®ã‚¿ãƒ¯ãƒ¼ã€‚å…¨ã¦ã®åå¿œã‚’å¼•ãèµ·ã“ã›ã‚‹ã€‚",flavorText:"ã€Œã‚ã‚‰ã‚†ã‚‹å…ƒç´ ã¯ã€ä¸€ã¤ã«é‚„ã‚‹ã€ - å¤§é­”å°Žå¸«ã‚¢ãƒ«ã‚±ã‚¤ãƒ³",baseStats:{damage:60,range:140,fireRate:900}}},N={normal:{type:"normal",name:"é€šå¸¸ã®æ•µ",icon:"ðŸ‘¹",color:"#e74c3c",description:"ç‰¹ã«èƒ½åŠ›ã‚’æŒãŸãªã„æ¨™æº–çš„ãªæ•µã€‚",flavorText:"ç¾¤ã‚Œã‚’ãªã—ã¦æŠ¼ã—å¯„ã›ã‚‹ã€ç„¡æ•°ã®é­”ç‰©ãŸã¡ã€‚",weakness:"ç‰¹ã«ãªã—",baseStats:{health:80,speed:1.5,attackDamage:5}},tank:{type:"tank",name:"ã‚¿ãƒ³ã‚¯",icon:"ðŸ›¡ï¸",color:"#8e44ad",description:"é«˜ã„HPã‚’æŒã¡ã€ç§»å‹•ã¯é…ã„ãŒéžå¸¸ã«é ‘ä¸ˆã€‚",flavorText:"é‹¼é‰„ã®éŽ§ã«èº«ã‚’åŒ…ã¿ã€ã©ã‚“ãªæ”»æ’ƒã‚‚æã‚Œãªã„ã€‚",weakness:"æ°·å±žæ€§ã§æ¸›é€Ÿã•ã›ã€é›†ä¸­æ”»æ’ƒ",baseStats:{health:250,speed:.8,attackDamage:15}},breaker:{type:"breaker",name:"ãƒ–ãƒ¬ã‚¤ã‚«ãƒ¼",icon:"ðŸ’£",color:"#e67e22",description:"ã‚¿ãƒ¯ãƒ¼ã«å‘ã‹ã£ã¦çªé€²ã—ã€æŽ¥è§¦ã™ã‚‹ã¨è‡ªçˆ†ã™ã‚‹å±é™ºãªæ•µã€‚",flavorText:"çˆ†ç™ºã«å‘½ã‚’æ§ã’ãŸç‹‚ä¿¡è€…ã€‚è¿‘ã¥ã„ã¦ã¯ãªã‚‰ãªã„ã€‚",weakness:"é è·é›¢ã‹ã‚‰é€Ÿæ”»ã§æ’ƒç ´",baseStats:{health:40,speed:2,attackDamage:80}},ghost:{type:"ghost",name:"ã‚´ãƒ¼ã‚¹ãƒˆ",icon:"ðŸ‘»",color:"#9b59b6",description:"ãƒ‘ã‚¹ã‚’ç„¡è¦–ã—ã¦ç›´æŽ¥æ‹ ç‚¹ã«å‘ã‹ã†ã€‚ç‰©ç†æ”»æ’ƒã‚’å›žé¿ã™ã‚‹ã€‚",flavorText:"å¹½ä½“ã¨ãªã£ãŸè€…ã¯ã€å£ã™ã‚‰ã™ã‚ŠæŠœã‘ã‚‹ã€‚",weakness:"å…ƒç´ æ”»æ’ƒã§ç¢ºå®Ÿã«ãƒ€ãƒ¡ãƒ¼ã‚¸",baseStats:{health:60,speed:1.2,attackDamage:8}},boss:{type:"boss",name:"é­”çŽ‹",icon:"ðŸ‘‘",color:"#c0392b",description:"10ã‚¦ã‚§ãƒ¼ãƒ–ã”ã¨ã«å‡ºç¾ã™ã‚‹å¼·å¤§ãªæ•µã€‚CCè€æ€§ã‚’æŒã¡ã€ç‰¹æ®Šèƒ½åŠ›ã‚’ä½¿ã†ã€‚",flavorText:"ã€Œæˆ‘ã¯ç ´å£Šã®åŒ–èº«ãªã‚Šã€‚ã²ã‚Œä¼ã›ã€æ„šã‹ãªè€…ã©ã‚‚ã‚ˆï¼ã€",weakness:"ç‰©ç†ã¨å±žæ€§ã‚’çµ„ã¿åˆã‚ã›ã€æŒä¹…æˆ¦ã§å‰Šã‚‹",baseStats:{health:2e3,speed:.5,attackDamage:30}}},G={fire_damage_up:{effect:"fire_damage_up",name:"ç‚Žã®å°ç« ",icon:"ðŸ”¥",description:"ç«å±žæ€§ã‚¿ãƒ¯ãƒ¼ã®ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’25%ä¸Šæ˜‡ã•ã›ã‚‹ã€‚",flavorText:"å¤ªå¤ã®ç‚Žã‚’å°ã˜ãŸç´‹ç« ã€‚æŒã¤è€…ã«ç«ã®åŠ›ã‚’ä¸Žãˆã‚‹ã€‚"},ice_damage_up:{effect:"ice_damage_up",name:"æ°·ã®å°ç« ",icon:"â„ï¸",description:"æ°·å±žæ€§ã‚¿ãƒ¯ãƒ¼ã®ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’25%ä¸Šæ˜‡ã•ã›ã‚‹ã€‚",flavorText:"æ°¸ä¹…å‡åœŸã®çµæ™¶ã€‚æ±ºã—ã¦æº¶ã‘ã‚‹ã“ã¨ã¯ãªã„ã€‚"},lightning_damage_up:{effect:"lightning_damage_up",name:"é›·ã®å°ç« ",icon:"âš¡",description:"é›·å±žæ€§ã‚¿ãƒ¯ãƒ¼ã®ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’25%ä¸Šæ˜‡ã•ã›ã‚‹ã€‚",flavorText:"é›·é›²ã‹ã‚‰è½ã¡ãŸç¨²å¦»ã®æ¬ ç‰‡ã€‚ä»Šã‚‚å¾®å¼±ãªé›»æµãŒæµã‚Œã‚‹ã€‚"},all_damage_up:{effect:"all_damage_up",name:"æˆ¦ç¥žã®åŠ è­·",icon:"âš”ï¸",description:"å…¨ã¦ã®ã‚¿ãƒ¯ãƒ¼ã®ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’15%ä¸Šæ˜‡ã•ã›ã‚‹ã€‚",flavorText:"æˆ¦ã®ç¥žã‚¢ãƒ¬ã‚¹ã®ç¥ç¦ã€‚å‹åˆ©ã‚’ç´„æŸã™ã‚‹ã€‚"},tower_hp_up:{effect:"tower_hp_up",name:"é‰„å£ã®å®ˆã‚Š",icon:"ðŸ›¡ï¸",description:"å…¨ã¦ã®ã‚¿ãƒ¯ãƒ¼ã®è€ä¹…åŠ›ã‚’50%ä¸Šæ˜‡ã•ã›ã‚‹ã€‚",flavorText:"å¤ä»£ã®é˜²å£ã‹ã‚‰å‰Šã‚Šå‡ºã•ã‚ŒãŸçŸ³ç‰‡ã€‚ä¸å±ˆã®å®ˆã‚Šã‚’æŽˆã‘ã‚‹ã€‚"},interest_rate_up:{effect:"interest_rate_up",name:"å•†äººã®çŸ¥æµ",icon:"ðŸ’°",description:"ã‚¦ã‚§ãƒ¼ãƒ–ã‚¯ãƒªã‚¢æ™‚ã®åˆ©å­çŽ‡ã‚’5%ä¸Šæ˜‡ã•ã›ã‚‹ã€‚",flavorText:"å¯Œã‚’å¢—ã‚„ã™ç§˜è¨£ã¯ã€ãŠé‡‘ã‚’çœ ã‚‰ã›ãªã„ã“ã¨ã€‚"},expansion_pack:{effect:"expansion_pack",name:"æ‹¡å¼µãƒ‘ãƒƒã‚¯",icon:"ðŸ“¦",description:"ã‚·ãƒ§ãƒƒãƒ—ã®é¸æŠžè‚¢ãŒ1ã¤å¢—ãˆã‚‹ã€‚",flavorText:"é¸æŠžè‚¢ãŒå¢—ãˆã‚‹ã“ã¨ã¯ã€å¸¸ã«è‰¯ã„ã“ã¨ã ã€‚"},vip_membership:{effect:"vip_membership",name:"VIPãƒ¡ãƒ³ãƒãƒ¼ã‚·ãƒƒãƒ—",icon:"ðŸ‘‘",description:"ãƒ¬ã‚¢ã‚¢ã‚¤ãƒ†ãƒ ã®å‡ºç¾çŽ‡ãŒ15%ä¸Šæ˜‡ã™ã‚‹ã€‚",flavorText:"ç‰¹åˆ¥ãªå¾…é‡ã‚’å—ã‘ã‚‹æ¨©åˆ©ã€‚é«˜ç´šå“ãŒæ‰‹ã«å…¥ã‚Šã‚„ã™ããªã‚‹ã€‚"},recycle_bin:{effect:"recycle_bin",name:"ãƒªã‚µã‚¤ã‚¯ãƒ«ãƒ“ãƒ³",icon:"â™»ï¸",description:"ã‚«ãƒ¼ãƒ‰ã‚’æ¨ã¦ãŸæ™‚ã«Tokenã‚’ç²å¾—ã™ã‚‹ã€‚",flavorText:"æ¨ã¦ã‚‹ã‚‚ã®ã«ã‚‚ä¾¡å€¤ãŒã‚ã‚‹ã€‚ãã‚Œã‚’æ´»ã‹ã™ã®ãŒçŸ¥æµã€‚"}},$={STORAGE_KEY:"elemental_deck_defense_encyclopedia"},D={masterVolume:80,sfxVolume:80,bgmVolume:60,showDamageNumbers:!0,showParticles:!0,showSynergyPreview:!0},U={STORAGE_KEY:"elemental_deck_defense_settings"};class R{constructor(e,t,s="normal",i=1,a,n=null){r(this,"position");r(this,"health");r(this,"maxHealth");r(this,"speed");r(this,"baseSpeed");r(this,"size");r(this,"color");r(this,"isAlive");r(this,"enemyType");r(this,"typeConfig");r(this,"resistance",null);r(this,"routeIndex");r(this,"status",null);r(this,"statusDuration",0);r(this,"isFrozen",!1);r(this,"freezeEndTime",0);r(this,"isSlowed",!1);r(this,"slowEndTime",0);r(this,"slowMultiplier",1);r(this,"attackDamage");r(this,"lastAttackTime",0);r(this,"attackCooldown");r(this,"evasionChance");r(this,"priority");r(this,"targetTower",null);r(this,"lastSkillTime",0);r(this,"skillCooldown");r(this,"ccImmunity");r(this,"pathIndex");r(this,"path");this.enemyType=s,this.typeConfig=V[s],this.resistance=n,this.path=e,this.routeIndex=t,this.pathIndex=0,this.position={...e[0]};const o=1+(i-1)*.25;a?(this.health=a.health,this.maxHealth=a.health,this.speed=a.speed,this.baseSpeed=a.speed,this.size=a.size,this.color=a.color):(this.health=Math.floor(this.typeConfig.baseHealth*o),this.maxHealth=this.health,this.speed=this.typeConfig.baseSpeed,this.baseSpeed=this.typeConfig.baseSpeed,this.size=this.typeConfig.size,this.color=this.typeConfig.color),this.attackDamage=Math.floor(this.typeConfig.attackDamage*o),this.attackCooldown=this.typeConfig.attackCooldown,this.evasionChance=this.typeConfig.evasionChance,this.priority=this.typeConfig.priority,this.skillCooldown=this.typeConfig.skillCooldown||5e3,this.ccImmunity=this.typeConfig.ccImmunity||0,this.lastSkillTime=0,this.isAlive=!0}isBoss(){return this.typeConfig.isBoss===!0}canUseSkill(e){return this.isBoss()?e-this.lastSkillTime>=this.skillCooldown:!1}useSkill(e){if(!this.canUseSkill(e))return null;this.lastSkillTime=e;const t=["summon","heal","silence"];return t[Math.floor(Math.random()*t.length)]}heal(e){this.health=Math.min(this.maxHealth,this.health+e)}tryEvade(){return Math.random()<this.evasionChance}canAttackTower(e){return e-this.lastAttackTime>=this.attackCooldown}attackTower(e,t){return this.lastAttackTime=t,this.enemyType==="breaker"&&(this.isAlive=!1,this.health=0),this.attackDamage}findNearestTower(e){let t=null,s=1/0;for(const i of e){if(!i.isAlive)continue;const a=i.position.x-this.position.x,n=i.position.y-this.position.y,o=Math.sqrt(a*a+n*n);o<s&&(s=o,t=i)}return t}moveTowardsTower(e){const t=e.position.x-this.position.x,s=e.position.y-this.position.y,i=Math.sqrt(t*t+s*s);if(i<this.size/2+e.size/2)return!0;const a=t/i*this.speed,n=s/i*this.speed;return this.position.x+=a,this.position.y+=n,!1}moveTowardsBase(){const{BASE_ROW:e,BASE_COL:t,GRID_SIZE:s}=g,i=t*s+s/2,a=e*s+s/2,n=i-this.position.x,o=a-this.position.y,l=Math.sqrt(n*n+o*o);if(l<s/2)return!0;const h=n/l*this.speed,c=o/l*this.speed;return this.position.x+=h,this.position.y+=c,!1}applyStatus(e,t=3e3){this.status=e,this.statusDuration=t}clearStatus(){this.status=null,this.statusDuration=0}freeze(e){const t=Math.floor(e*(1-this.ccImmunity));t<200||(this.isFrozen=!0,this.freezeEndTime=Date.now()+t,this.status="frozen")}applySlow(e,t){const s=Math.floor(e*(1-this.ccImmunity));s<200||(this.isSlowed=!0,this.slowEndTime=Date.now()+s,this.slowMultiplier=t,this.speed=this.baseSpeed*t)}update(e){if(!this.isAlive)return!1;const t=Date.now();return this.isFrozen&&t>=this.freezeEndTime&&(this.isFrozen=!1,this.status==="frozen"&&this.clearStatus()),this.isSlowed&&t>=this.slowEndTime&&(this.isSlowed=!1,this.slowMultiplier=1,this.speed=this.baseSpeed),this.isFrozen?!1:(this.statusDuration>0&&(this.statusDuration-=16,this.statusDuration<=0&&this.clearStatus()),this.typeConfig.ignoresPath?this.moveTowardsBase():this.typeConfig.targetsNearestTower&&e&&e.length>0&&((!this.targetTower||!this.targetTower.isAlive)&&(this.targetTower=this.findNearestTower(e)),this.targetTower)?this.moveTowardsTower(this.targetTower):this.followPath())}followPath(){if(this.pathIndex>=this.path.length-1)return!0;const e=this.path[this.pathIndex+1],t=e.x-this.position.x,s=e.y-this.position.y,i=Math.sqrt(t*t+s*s);if(i<this.speed){if(this.pathIndex++,this.pathIndex>=this.path.length-1)return!0}else{const a=t/i*this.speed,n=s/i*this.speed;this.position.x+=a,this.position.y+=n}return!1}takeDamage(e,t){return t==="physical"?(this.health-=e,this.health<=0&&(this.health=0,this.isAlive=!1),e):this.resistance&&t===this.resistance?(this.health-=1,this.health<=0&&(this.health=0,this.isAlive=!1),1):(this.health-=e,this.health<=0&&(this.health=0,this.isAlive=!1),e)}isResistantTo(e){return e==="physical"?!1:this.resistance===e}draw(e){if(!this.isAlive)return;const t=this.size/2;this.enemyType==="ghost"&&(e.globalAlpha=.6),this.resistance&&this.drawResistanceAura(e),this.isFrozen&&(e.beginPath(),e.arc(this.position.x,this.position.y,t+8,0,Math.PI*2),e.fillStyle="rgba(135, 206, 235, 0.4)",e.fill(),e.strokeStyle="#87CEEB",e.lineWidth=2,e.stroke()),this.isSlowed&&!this.isFrozen&&(e.beginPath(),e.arc(this.position.x,this.position.y,t+5,0,Math.PI*2),e.strokeStyle="rgba(135, 206, 235, 0.6)",e.lineWidth=2,e.setLineDash([3,3]),e.stroke(),e.setLineDash([]));const s=this.isFrozen?"#87CEEB":this.color;switch(this.enemyType){case"boss":this.drawBoss(e,s);break;case"tank":this.drawHexagon(e,s);break;case"breaker":this.drawTriangle(e,s);break;case"ghost":this.drawCircle(e,s);break;default:this.drawSquare(e,s);break}this.status&&this.status!=="frozen"&&this.drawStatusIcon(e),this.resistance&&this.drawResistanceIcon(e),e.font=`${Math.floor(this.size*.5)}px sans-serif`,e.textAlign="center",e.textBaseline="middle",e.fillStyle="#fff",e.fillText(this.typeConfig.icon,this.position.x,this.position.y);const i=this.size,a=4,n=this.position.y-t-8,o=this.health/this.maxHealth;e.fillStyle="#333",e.fillRect(this.position.x-t,n,i,a),e.fillStyle=o>.5?"#2ecc71":o>.25?"#f39c12":"#e74c3c",e.fillRect(this.position.x-t,n,i*o,a),this.enemyType==="ghost"&&(e.globalAlpha=1)}drawSquare(e,t){const s=this.size/2;e.fillStyle=t,e.fillRect(this.position.x-s,this.position.y-s,this.size,this.size),e.strokeStyle=this.getDarkerColor(t),e.lineWidth=2,e.strokeRect(this.position.x-s,this.position.y-s,this.size,this.size)}drawHexagon(e,t){const s=this.size/2;e.beginPath();for(let i=0;i<6;i++){const a=Math.PI/3*i-Math.PI/6,n=this.position.x+s*Math.cos(a),o=this.position.y+s*Math.sin(a);i===0?e.moveTo(n,o):e.lineTo(n,o)}e.closePath(),e.fillStyle=t,e.fill(),e.strokeStyle=this.getDarkerColor(t),e.lineWidth=3,e.stroke()}drawTriangle(e,t){const s=this.size/2;e.beginPath(),e.moveTo(this.position.x,this.position.y-s),e.lineTo(this.position.x+s,this.position.y+s),e.lineTo(this.position.x-s,this.position.y+s),e.closePath(),e.fillStyle=t,e.fill(),e.strokeStyle=this.getDarkerColor(t),e.lineWidth=2,e.stroke()}drawCircle(e,t){const s=this.size/2;e.beginPath(),e.arc(this.position.x,this.position.y,s,0,Math.PI*2),e.fillStyle=t,e.fill(),e.strokeStyle=this.getDarkerColor(t),e.lineWidth=2,e.stroke()}drawBoss(e,t){const s=this.size/2,i=Date.now()/1e3,a=1+Math.sin(i*2)*.1,n=s*1.5*a,o=e.createRadialGradient(this.position.x,this.position.y,s,this.position.x,this.position.y,n);o.addColorStop(0,"rgba(192, 57, 43, 0.6)"),o.addColorStop(.5,"rgba(192, 57, 43, 0.3)"),o.addColorStop(1,"rgba(192, 57, 43, 0)"),e.beginPath(),e.arc(this.position.x,this.position.y,n,0,Math.PI*2),e.fillStyle=o,e.fill(),e.beginPath();for(let l=0;l<8;l++){const h=Math.PI/4*l-Math.PI/8,c=this.position.x+s*Math.cos(h),d=this.position.y+s*Math.sin(h);l===0?e.moveTo(c,d):e.lineTo(c,d)}e.closePath(),e.fillStyle=t,e.fill(),e.strokeStyle="#ffd700",e.lineWidth=4,e.stroke(),e.beginPath(),e.arc(this.position.x,this.position.y,s*.6,0,Math.PI*2),e.strokeStyle="rgba(255, 215, 0, 0.5)",e.lineWidth=2,e.stroke()}drawResistanceAura(e){if(!this.resistance)return;const t=this.size/2,s=t+12,i=Date.now()/1e3,a=.7+Math.sin(i*3)*.3;let n,o,l;switch(this.resistance){case"fire":n=`rgba(231, 76, 60, ${.4*a})`,o="rgba(231, 76, 60, 0.6)",l="rgba(231, 76, 60, 0)";break;case"ice":n=`rgba(52, 152, 219, ${.4*a})`,o="rgba(52, 152, 219, 0.6)",l="rgba(52, 152, 219, 0)";break;case"lightning":n=`rgba(241, 196, 15, ${.4*a})`,o="rgba(241, 196, 15, 0.6)",l="rgba(241, 196, 15, 0)";break;default:return}const h=e.createRadialGradient(this.position.x,this.position.y,t,this.position.x,this.position.y,s);h.addColorStop(0,o),h.addColorStop(1,l),e.beginPath(),e.arc(this.position.x,this.position.y,s,0,Math.PI*2),e.fillStyle=h,e.fill(),e.beginPath(),e.arc(this.position.x,this.position.y,t+3,0,Math.PI*2),e.strokeStyle=n,e.lineWidth=2,e.stroke()}drawResistanceIcon(e){if(!this.resistance)return;const t=this.size/2,s=this.position.x-t-2,i=this.position.y-t-2;e.beginPath(),e.arc(s,i,9,0,Math.PI*2);let a;switch(this.resistance){case"fire":a="rgba(231, 76, 60, 0.9)";break;case"ice":a="rgba(52, 152, 219, 0.9)";break;case"lightning":a="rgba(241, 196, 15, 0.9)";break;default:a="rgba(100, 100, 100, 0.9)"}e.fillStyle=a,e.fill(),e.strokeStyle="#fff",e.lineWidth=1,e.stroke(),e.font="10px sans-serif",e.textAlign="center",e.textBaseline="middle",e.fillStyle="#fff",e.fillText("ðŸ›¡ï¸",s,i)}drawStatusIcon(e){if(!this.status)return;const t=this.size/2,s=this.position.x+t-4,i=this.position.y-t-4;e.beginPath(),e.arc(s,i,8,0,Math.PI*2),e.fillStyle="rgba(0, 0, 0, 0.6)",e.fill();let a="";switch(this.status){case"fire":a=T.fire.icon;break;case"ice":a=T.ice.icon;break;case"lightning":a=T.lightning.icon;break;case"oil":a="ðŸ›¢ï¸";break}e.font="10px sans-serif",e.textAlign="center",e.textBaseline="middle",e.fillStyle="#fff",e.fillText(a,s,i)}getDarkerColor(e){const t=e.replace("#",""),s=Math.floor(parseInt(t.substring(0,2),16)*.7),i=Math.floor(parseInt(t.substring(2,4),16)*.7),a=Math.floor(parseInt(t.substring(4,6),16)*.7);return`rgb(${s}, ${i}, ${a})`}getCenter(){return{...this.position}}}class ee{constructor(e,t,s,i=Q){r(this,"position");r(this,"speed");r(this,"size");r(this,"color");r(this,"damage");r(this,"isActive");r(this,"element");r(this,"criticalChance",.1);r(this,"criticalMultiplier",2);r(this,"target");r(this,"velocity");r(this,"trail");r(this,"maxTrailLength",5);this.position={...e},this.target=t,this.element=s,this.speed=i.speed,this.size=i.size,this.color=i.color,this.damage=i.damage,this.isActive=!0,this.velocity={x:0,y:0},this.trail=[],this.updateVelocity()}updateVelocity(){if(!this.target.isAlive)return;const e=this.target.getCenter(),t=e.x-this.position.x,s=e.y-this.position.y,i=Math.sqrt(t*t+s*s);i>0&&(this.velocity.x=t/i*this.speed,this.velocity.y=s/i*this.speed)}update(){if(!this.isActive)return null;if(this.trail.push({...this.position}),this.trail.length>this.maxTrailLength&&this.trail.shift(),this.target.isAlive&&this.updateVelocity(),this.position.x+=this.velocity.x,this.position.y+=this.velocity.y,this.isOutOfBounds())return this.isActive=!1,null;if(this.target.isAlive&&this.checkCollision()){const e=Math.random()<this.criticalChance,t=e?Math.floor(this.damage*this.criticalMultiplier):this.damage;return this.isActive=!1,{hit:!0,damage:t,isCritical:e,position:{...this.position},targetDied:!1,targetColor:this.target.color,element:this.element,target:this.target}}return null}isOutOfBounds(){const{CANVAS_WIDTH:e,CANVAS_HEIGHT:t}=g;return this.position.x<-50||this.position.x>e+50||this.position.y<-50||this.position.y>t+50}checkCollision(){const e=this.target.getCenter(),t=e.x-this.position.x,s=e.y-this.position.y,i=Math.sqrt(t*t+s*s),a=this.size+this.target.size/2;return i<a}draw(e){if(this.isActive){if(this.trail.length>1){for(let t=0;t<this.trail.length-1;t++){const s=(t+1)/this.trail.length*.5,i=this.size*(t+1)/this.trail.length;e.beginPath(),e.arc(this.trail[t].x,this.trail[t].y,i,0,Math.PI*2),e.fillStyle=this.color,e.globalAlpha=s,e.fill()}e.globalAlpha=1}e.beginPath(),e.arc(this.position.x,this.position.y,this.size,0,Math.PI*2),e.fillStyle=this.color,e.fill(),e.beginPath(),e.arc(this.position.x,this.position.y,this.size+2,0,Math.PI*2),e.strokeStyle=`${this.color}80`,e.lineWidth=2,e.stroke(),e.beginPath(),e.arc(this.position.x-this.size*.3,this.position.y-this.size*.3,this.size*.3,0,Math.PI*2),e.fillStyle="rgba(255, 255, 255, 0.6)",e.fill()}}}class te{constructor(e,t,s,i="ice",a=1,n){r(this,"position");r(this,"element");r(this,"level");r(this,"range");r(this,"fireRate");r(this,"baseDamage");r(this,"size");r(this,"gridRow");r(this,"gridCol");r(this,"hp");r(this,"maxHp");r(this,"isAlive");r(this,"isSilenced",!1);r(this,"silenceEndTime",0);r(this,"activeSynergies");r(this,"synergyDamageMultiplier");r(this,"lastFireTime");r(this,"currentTarget");r(this,"animationScale");r(this,"animationPhase");r(this,"animationTimer");this.gridRow=e,this.gridCol=t,this.position={...s},this.element=i,this.level=Math.min(a,A);const o=n??x(i,this.level);this.range=o.range,this.fireRate=o.fireRate,this.baseDamage=o.damage,this.size=o.size,this.maxHp=100+(this.level-1)*50,this.hp=this.maxHp,this.isAlive=!0,this.activeSynergies=[],this.synergyDamageMultiplier=1,this.lastFireTime=0,this.currentTarget=null,this.animationScale=1,this.animationPhase="idle",this.animationTimer=0}takeDamage(e){return this.isAlive?(this.hp-=e,this.triggerDamageAnimation(),this.hp<=0?(this.hp=0,this.isAlive=!1,!0):!1):!1}applySilence(e){this.isSilenced=!0,this.silenceEndTime=Date.now()+e}checkSilenced(){return this.isSilenced&&Date.now()>=this.silenceEndTime&&(this.isSilenced=!1),this.isSilenced}triggerDamageAnimation(){this.animationPhase="damage",this.animationTimer=0}heal(e){this.isAlive&&(this.hp=Math.min(this.maxHp,this.hp+e))}getElementConfig(){return T[this.element]}getEffectiveDamage(){return Math.floor(this.baseDamage*this.synergyDamageMultiplier)}setSynergies(e){this.activeSynergies=e,this.synergyDamageMultiplier=e.reduce((t,s)=>t*s.damageMultiplier,1)}clearSynergies(){this.activeSynergies=[],this.synergyDamageMultiplier=1}levelUp(){if(this.level>=A)return!1;this.level++;const e=x(this.element,this.level);return this.range=e.range,this.fireRate=e.fireRate,this.baseDamage=e.damage,this.size=e.size,this.maxHp=100+(this.level-1)*50,this.hp=this.maxHp,this.triggerFireAnimation(),!0}canMergeWith(e,t){return this.element===e&&this.level===t&&this.level<A}triggerFireAnimation(){this.animationPhase="squash",this.animationTimer=0}updateAnimation(){switch(this.animationPhase){case"squash":this.animationTimer++,this.animationScale=1-this.animationTimer/4*.15,this.animationTimer>=4&&(this.animationPhase="stretch",this.animationTimer=0);break;case"stretch":this.animationTimer++,this.animationScale=.85+this.animationTimer/6*.3,this.animationTimer>=6&&(this.animationPhase="recover",this.animationTimer=0);break;case"recover":this.animationTimer++,this.animationScale=1.15-this.animationTimer/8*.15,this.animationTimer>=8&&(this.animationPhase="idle",this.animationScale=1);break;case"damage":this.animationTimer++,this.animationScale=1+Math.sin(this.animationTimer*.8)*.1,this.animationTimer>=10&&(this.animationPhase="idle",this.animationScale=1);break;case"idle":default:this.animationScale=1;break}}findTarget(e){if(this.currentTarget&&this.currentTarget.isAlive&&this.isInRange(this.currentTarget))return;this.currentTarget=null;let t=0,s=1/0;for(const i of e){if(!i.isAlive)continue;const a=this.getDistanceTo(i);if(a>this.range)continue;const n=i.priority;(n>t||n===t&&a<s)&&(t=n,s=a,this.currentTarget=i)}}tryFire(e){if(this.isSilenced)if(e>=this.silenceEndTime)this.isSilenced=!1;else return null;if(!this.currentTarget||!this.currentTarget.isAlive||e-this.lastFireTime<this.fireRate)return null;if(!this.isInRange(this.currentTarget))return this.currentTarget=null,null;this.triggerFireAnimation();const t=this.getElementConfig();this.lastFireTime=e;const i=this.activeSynergies.length>0?8:6;return new ee({...this.position},this.currentTarget,this.element,{speed:8,size:i,color:t.projectileColor,damage:this.getEffectiveDamage()})}isInRange(e){return this.getDistanceTo(e)<=this.range}getDistanceTo(e){const t=e.getCenter(),s=t.x-this.position.x,i=t.y-this.position.y;return Math.sqrt(s*s+i*i)}getLevelAdjustedColor(e){const t=X[this.level]??1,s=e.replace("#",""),i=Math.floor(parseInt(s.substring(0,2),16)*t),a=Math.floor(parseInt(s.substring(2,4),16)*t),n=Math.floor(parseInt(s.substring(4,6),16)*t);return`rgb(${i}, ${a}, ${n})`}draw(e,t=!1){this.updateAnimation(),this.checkSilenced();const s=this.getElementConfig(),i=this.activeSynergies.length>0,a=this.size*this.animationScale,n=a/2;if(this.isSilenced&&(e.beginPath(),e.arc(this.position.x,this.position.y,this.size*.7,0,Math.PI*2),e.fillStyle="rgba(128, 0, 128, 0.4)",e.fill(),e.strokeStyle="#800080",e.lineWidth=3,e.setLineDash([5,5]),e.stroke(),e.setLineDash([])),i&&!this.isSilenced){e.beginPath(),e.arc(this.position.x,this.position.y,this.size*.8,0,Math.PI*2),e.fillStyle="rgba(255, 215, 0, 0.3)",e.fill();const h=this.size*.9+Math.sin(Date.now()/200)*3;e.beginPath(),e.arc(this.position.x,this.position.y,h,0,Math.PI*2),e.strokeStyle="rgba(255, 215, 0, 0.5)",e.lineWidth=2,e.stroke()}t&&(e.beginPath(),e.arc(this.position.x,this.position.y,this.range,0,Math.PI*2),e.fillStyle=`${s.color}20`,e.fill(),e.strokeStyle=`${s.color}50`,e.lineWidth=1,e.stroke()),e.save(),this.animationPhase==="stretch"&&(e.shadowColor=s.projectileColor,e.shadowBlur=15);const o=this.getLevelAdjustedColor(s.color);e.fillStyle=o,e.fillRect(this.position.x-n,this.position.y-n,a,a),e.strokeStyle=this.getLevelAdjustedColor(s.borderColor),e.lineWidth=2+this.level,e.strokeRect(this.position.x-n,this.position.y-n,a,a),e.restore();const l=(4+this.level*2)*this.animationScale;if(e.beginPath(),e.arc(this.position.x,this.position.y,l,0,Math.PI*2),e.fillStyle="#2c3e50",e.fill(),e.font=`${12+this.level*2}px sans-serif`,e.textAlign="center",e.textBaseline="middle",e.fillText(s.icon,this.position.x,this.position.y-this.size/2-10),this.level>1){e.font="bold 10px sans-serif",e.fillStyle="#fff",e.strokeStyle="#000",e.lineWidth=2;const h=`Lv${this.level}`;e.strokeText(h,this.position.x+this.size/2-2,this.position.y+this.size/2-2),e.fillText(h,this.position.x+this.size/2-2,this.position.y+this.size/2-2)}if(i){e.font="10px sans-serif";const h=this.activeSynergies.map(c=>c.icon).join("");e.fillText(h,this.position.x-this.size/2+8,this.position.y-this.size/2+8)}if(this.currentTarget&&this.currentTarget.isAlive){const h=this.currentTarget.getCenter();e.beginPath(),e.moveTo(this.position.x,this.position.y),e.lineTo(h.x,h.y),e.strokeStyle=i?"rgba(255, 215, 0, 0.5)":`${s.projectileColor}50`,e.lineWidth=1,e.stroke()}this.drawHealthBar(e),this.animationPhase==="damage"&&(e.fillStyle=`rgba(255, 0, 0, ${.3+Math.sin(this.animationTimer*.8)*.2})`,e.fillRect(this.position.x-n,this.position.y-n,a,a))}drawHealthBar(e){const t=this.size,s=4,i=this.position.y+this.size/2+4,a=this.position.x-t/2,n=this.hp/this.maxHp;e.fillStyle="#333",e.fillRect(a,i,t,s);let o;n>.6?o="#2ecc71":n>.3?o="#f39c12":o="#e74c3c",e.fillStyle=o,e.fillRect(a,i,t*n,s),e.strokeStyle="#555",e.lineWidth=1,e.strokeRect(a,i,t,s)}}class k{constructor(e,t,s,i){r(this,"id");r(this,"cardType");r(this,"element");r(this,"spellType");r(this,"position");r(this,"width");r(this,"height");r(this,"isDragging");r(this,"dragOffset");r(this,"originalPosition");this.id=`card-${Date.now()}-${Math.random().toString(36).substring(2,9)}`,this.cardType=e,this.element=s??null,this.spellType=i??null,this.position={...t},this.originalPosition={...t},this.width=C.CARD_WIDTH,this.height=C.CARD_HEIGHT,this.isDragging=!1,this.dragOffset={x:0,y:0}}isTowerCard(){return this.cardType==="tower"&&this.element!==null}isSpellCard(){return this.cardType==="spell"&&this.spellType!==null}getElementConfig(){return this.element?T[this.element]:null}getSpellConfig(){return this.spellType?w[this.spellType]:null}getColor(){return this.cardType==="tower"&&this.element?T[this.element].color:this.cardType==="spell"&&this.spellType?w[this.spellType].color:"#888"}getBorderColor(){return this.cardType==="tower"&&this.element?T[this.element].borderColor:this.cardType==="spell"&&this.spellType?w[this.spellType].borderColor:"#666"}getIcon(){return this.cardType==="tower"&&this.element?T[this.element].icon:this.cardType==="spell"&&this.spellType?w[this.spellType].icon:"?"}getName(){return this.cardType==="tower"&&this.element?T[this.element].name:this.cardType==="spell"&&this.spellType?w[this.spellType].name:"???"}startDrag(e,t){this.isDragging=!0,this.dragOffset={x:e-this.position.x,y:t-this.position.y}}updateDragPosition(e,t){this.isDragging&&(this.position={x:e-this.dragOffset.x,y:t-this.dragOffset.y})}endDrag(){this.isDragging=!1}resetPosition(){this.position={...this.originalPosition},this.isDragging=!1}setOriginalPosition(e){this.originalPosition={...e},this.position={...e}}containsPoint(e,t){return e>=this.position.x&&e<=this.position.x+this.width&&t>=this.position.y&&t<=this.position.y+this.height}createElement(){const e=document.createElement("div");e.className=`card ${this.cardType}-card`,e.dataset.cardId=this.id,e.dataset.cardType=this.cardType,this.element&&(e.dataset.element=this.element),this.spellType&&(e.dataset.spellType=this.spellType);const t=this.getIcon(),s=this.getName(),i=this.getColor(),a=this.getBorderColor(),n=this.cardType==="spell"?'<div class="card-type-label">SPELL</div>':"";return e.innerHTML=`
      ${n}
      <div class="card-icon">${t}</div>
      <div class="card-name">${s}</div>
    `,e.style.setProperty("--card-color",i),e.style.setProperty("--card-border-color",a),e}drawPreview(e){if(!this.isDragging)return;const t=30,s=t/2,i=this.getColor(),a=this.getBorderColor();e.globalAlpha=.7,this.cardType==="tower"?(e.fillStyle=i,e.fillRect(this.position.x+this.width/2-s,this.position.y+this.height/2-s,t,t),e.strokeStyle=a,e.lineWidth=2,e.strokeRect(this.position.x+this.width/2-s,this.position.y+this.height/2-s,t,t)):(e.beginPath(),e.arc(this.position.x+this.width/2,this.position.y+this.height/2,t,0,Math.PI*2),e.fillStyle=`${i}40`,e.fill(),e.strokeStyle=i,e.lineWidth=3,e.stroke()),e.globalAlpha=1}}const F=p=>{const e=["fire","ice","lightning"],t=e[Math.floor(Math.random()*e.length)];return new k("tower",p,t)},se=p=>{const e=["meteor","blizzard","oil_bomb"],t=e[Math.floor(Math.random()*e.length)];return new k("spell",p,void 0,t)},ie=p=>Math.random()<C.SPELL_CHANCE?se(p):F(p);class ae{constructor(){r(this,"paths");r(this,"pathCells");r(this,"basePosition");this.paths=[[],[],[],[]],this.pathCells=new Set;const{GRID_SIZE:e,BASE_ROW:t,BASE_COL:s}=g;this.basePosition={x:s*e+e/2,y:t*e+e/2},this.generateAllPaths()}generateAllPaths(){this.paths[0]=this.generatePath(this.getRoute0Waypoints()),this.paths[1]=this.generatePath(this.getRoute1Waypoints()),this.paths[2]=this.generatePath(this.getRoute2Waypoints()),this.paths[3]=this.generatePath(this.getRoute3Waypoints())}getRoute0Waypoints(){return[[0,0],[0,2],[5,2],[5,6],[7,6],[7,7]]}getRoute1Waypoints(){return[[0,14],[0,12],[5,12],[5,8],[7,8],[7,7]]}getRoute2Waypoints(){return[[14,0],[14,2],[9,2],[9,6],[7,6],[7,7]]}getRoute3Waypoints(){return[[14,14],[14,12],[9,12],[9,8],[7,8],[7,7]]}generatePath(e){const{GRID_SIZE:t}=g,s=t/2,i=[];for(let o=0;o<e.length-1;o++){const[l,h]=e[o],[c,d]=e[o+1];i.push({x:h*t+s,y:l*t+s}),this.pathCells.add(`${l},${h}`);const m=c>l?1:c<l?-1:0,f=d>h?1:d<h?-1:0;let u=l,y=h;for(;u!==c||y!==d;)u!==c?u+=m:y!==d&&(y+=f),i.push({x:y*t+s,y:u*t+s}),this.pathCells.add(`${u},${y}`)}const[a,n]=e[e.length-1];return(i.length===0||i[i.length-1].x!==n*t+s||i[i.length-1].y!==a*t+s)&&(i.push({x:n*t+s,y:a*t+s}),this.pathCells.add(`${a},${n}`)),i}getPath(e){return[...this.paths[e]]}getRandomRouteIndex(){return Math.floor(Math.random()*4)}getRouteCount(){return this.paths.length}getBasePosition(){return{...this.basePosition}}isPathCell(e,t){return this.pathCells.has(`${e},${t}`)}isBaseCell(e,t){const{BASE_ROW:s,BASE_COL:i}=g;return e===s&&t===i}draw(e){const{GRID_SIZE:t,PATH_COLOR:s,BASE_ROW:i,BASE_COL:a,BASE_COLOR:n}=g;e.fillStyle=s;for(const h of this.pathCells){const[c,d]=h.split(",").map(Number);this.isBaseCell(c,d)||e.fillRect(d*t,c*t,t,t)}for(let h=0;h<this.paths.length;h++){const c=this.paths[h];if(c.length>1){e.beginPath(),e.moveTo(c[0].x,c[0].y);for(let d=1;d<c.length;d++)e.lineTo(c[d].x,c[d].y);e.strokeStyle=`${O[h]}60`,e.lineWidth=2,e.stroke(),e.beginPath(),e.arc(c[0].x,c[0].y,10,0,Math.PI*2),e.fillStyle=O[h],e.fill(),e.strokeStyle="#fff",e.lineWidth=2,e.stroke()}}const o=a*t,l=i*t;e.fillStyle=`${n}20`,e.fillRect((a-1)*t,(i-1)*t,t*3,t*3),e.fillStyle=`${n}60`,e.fillRect(o,l,t,t),e.strokeStyle=n,e.lineWidth=3,e.strokeRect(o+2,l+2,t-4,t-4),e.font="bold 20px sans-serif",e.textAlign="center",e.textBaseline="middle",e.fillStyle="#fff",e.fillText("ðŸ°",this.basePosition.x,this.basePosition.y)}}class ne{constructor(e){r(this,"cells");r(this,"pathSystem");this.pathSystem=e,this.cells=this.initializeGrid()}initializeGrid(){const{GRID_ROWS:e,GRID_COLS:t}=g,s=[];for(let i=0;i<e;i++){s[i]=[];for(let a=0;a<t;a++)s[i][a]={row:i,col:a,isPath:this.pathSystem.isPathCell(i,a)||this.pathSystem.isBaseCell(i,a),isOccupied:!1}}return s}getGridPosition(e,t){const{GRID_SIZE:s,GRID_ROWS:i,GRID_COLS:a}=g,n=Math.floor(e/s),o=Math.floor(t/s);return o<0||o>=i||n<0||n>=a?null:{row:o,col:n}}getCellCenter(e,t){const{GRID_SIZE:s}=g;return{x:t*s+s/2,y:e*s+s/2}}canPlaceTower(e,t){const{GRID_ROWS:s,GRID_COLS:i}=g;if(e<0||e>=s||t<0||t>=i)return!1;const a=this.cells[e][t];return!a.isPath&&!a.isOccupied}occupyCell(e,t){this.cells[e]&&this.cells[e][t]&&(this.cells[e][t].isOccupied=!0)}releaseCell(e,t){this.cells[e]&&this.cells[e][t]&&(this.cells[e][t].isOccupied=!1)}draw(e){const{GRID_SIZE:t,GRID_ROWS:s,GRID_COLS:i,GRID_COLOR:a}=g;e.strokeStyle=a,e.lineWidth=.5;for(let n=0;n<=i;n++)e.beginPath(),e.moveTo(n*t,0),e.lineTo(n*t,s*t),e.stroke();for(let n=0;n<=s;n++)e.beginPath(),e.moveTo(0,n*t),e.lineTo(i*t,n*t),e.stroke();e.strokeStyle=`${a}`,e.lineWidth=1;for(let n=0;n<=i;n+=5)e.beginPath(),e.moveTo(n*t,0),e.lineTo(n*t,s*t),e.stroke();for(let n=0;n<=s;n+=5)e.beginPath(),e.moveTo(0,n*t),e.lineTo(i*t,n*t),e.stroke()}drawHoverCell(e,t,s){const{GRID_SIZE:i}=g,a=this.canPlaceTower(t,s);e.fillStyle=a?"rgba(46, 204, 113, 0.3)":"rgba(231, 76, 60, 0.3)",e.fillRect(s*i,t*i,i,i),e.strokeStyle=a?"#2ecc71":"#e74c3c",e.lineWidth=2,e.strokeRect(s*i,t*i,i,i)}}class re{constructor(e){r(this,"cards");r(this,"handContainer");r(this,"draggedCard");r(this,"onCardDragStart");r(this,"onCardDragEnd");const t=document.getElementById(e);if(!t)throw new Error(`æ‰‹æœ­ã‚³ãƒ³ãƒ†ãƒŠè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ${e}`);this.handContainer=t,this.cards=[],this.draggedCard=null,this.onCardDragStart=null,this.onCardDragEnd=null}setOnCardDragStart(e){this.onCardDragStart=e}setOnCardDragEnd(e){this.onCardDragEnd=e}dealNewHand(){this.cards=[],this.handContainer.innerHTML="";const e=Math.min(3,C.HAND_SIZE);for(let t=0;t<C.HAND_SIZE;t++){let s;t<e?s=F({x:0,y:0}):s=ie({x:0,y:0}),this.cards.push(s),this.addCardToDOM(s)}}addCardToDOM(e){const t=e.createElement();t.draggable=!0,t.addEventListener("dragstart",s=>{this.handleDragStart(s,e)}),t.addEventListener("dragend",s=>{this.handleDragEnd(s,e)}),this.handContainer.appendChild(t)}handleDragStart(e,t){if(this.draggedCard=t,e.dataTransfer){e.dataTransfer.effectAllowed="move",e.dataTransfer.setData("text/plain",t.id),e.dataTransfer.setData("cardType",t.cardType);const i=this.createDragImage(t);document.body.appendChild(i),e.dataTransfer.setDragImage(i,40,40),setTimeout(()=>i.remove(),0)}e.target.classList.add("dragging"),this.onCardDragStart&&this.onCardDragStart(t)}createDragImage(e){const t=e.getIcon(),s=e.getColor(),i=e.getBorderColor(),a=document.createElement("div");a.className="drag-preview",a.innerHTML=t;const n=e.isSpellCard()?"50%":"8px";return a.style.cssText=`
      position: absolute;
      left: -9999px;
      width: 80px;
      height: 80px;
      background: ${s};
      border: 3px solid ${i};
      border-radius: ${n};
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2rem;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
    `,a}handleDragEnd(e,t){const s=this.handContainer.querySelector(`[data-card-id="${t.id}"]`);s&&s.classList.remove("dragging");const i=e.clientX,a=e.clientY;let n=!1;this.onCardDragEnd&&(n=this.onCardDragEnd(t,i,a)),n&&this.removeCard(t),this.draggedCard=null}removeCard(e){const t=this.cards.findIndex(s=>s.id===e.id);if(t!==-1){this.cards.splice(t,1);const s=this.handContainer.querySelector(`[data-card-id="${e.id}"]`);s&&s.remove()}}getDraggedCard(){return this.draggedCard}getCards(){return[...this.cards]}isEmpty(){return this.cards.length===0}setHand(e){this.cards=[],this.handContainer.innerHTML="";for(const t of e)this.cards.push(t),this.addCardToDOM(t)}addTowerCard(e){const t=new k("tower",{x:0,y:0},e);this.cards.push(t),this.addCardToDOM(t)}addSpellCard(e){const t=new k("spell",{x:0,y:0},void 0,e);this.cards.push(t),this.addCardToDOM(t)}getTowerCardCount(){return this.cards.filter(e=>e.isTowerCard()).length}getSpellCardCount(){return this.cards.filter(e=>e.isSpellCard()).length}addCard(e){this.cards.push(e),this.addCardToDOM(e)}discardOldestCard(){if(this.cards.length===0)return null;const e=this.cards[0];return this.removeCard(e),e}getCardCount(){return this.cards.length}}class oe{calculateAndApplySynergies(e){const t=this.createTowerMap(e);for(const s of e){const i=this.calculateSynergiesForTower(s,t);s.setSynergies(i)}}createTowerMap(e){const t=new Map;for(const s of e){const i=`${s.gridRow},${s.gridCol}`;t.set(i,s)}return t}calculateSynergiesForTower(e,t){const s=[],i=this.getAdjacentTowers(e,t),a=new Set;for(const n of i)a.add(n.element);for(const n of Object.values(Z))e.element===n.sourceElement&&a.has(n.requiredElement)&&s.push(n);return s}getAdjacentTowers(e,t){const{gridRow:s,gridCol:i}=e,{GRID_ROWS:a,GRID_COLS:n}=g,o=[[-1,0],[1,0],[0,-1],[0,1]],l=[];for(const[h,c]of o){const d=s+h,m=i+c;if(d<0||d>=a||m<0||m>=n)continue;const f=`${d},${m}`,u=t.get(f);u&&l.push(u)}return l}previewSynergies(e,t,s,i){const a=this.createTowerMap(i),n={gridRow:t,gridCol:s,element:e},o=`${t},${s}`;a.set(o,n);const l=this.calculateSynergiesForTower(n,a),h=[],c=[[-1,0],[1,0],[0,-1],[0,1]];for(const[d,m]of c){const f=t+d,u=s+m,y=i.find(v=>v.gridRow===f&&v.gridCol===u);if(y){const v=this.calculateSynergiesForTower(y,a);v.length!==y.activeSynergies.length&&h.push({tower:y,newSynergies:v})}}return{newTowerSynergies:l,affectedTowers:h}}getActiveSynergySummary(e){const t=new Map;for(const s of e)for(const i of s.activeSynergies){const a=t.get(i.name)??0;t.set(i.name,a+1)}return t}}class le{checkAndTriggerReaction(e,t,s,i){const a=e.status;if(!a)return e.applyStatus(t),null;for(const[n,o]of Object.entries(P)){const[l,h]=o.trigger;if(a===l&&t===h)return this.executeReaction(n,o,e,s,i)}return e.applyStatus(t),null}executeReaction(e,t,s,i,a){const n=s.getCenter(),o=[s];let l=i;switch(e){case"melt":l=Math.floor(i*(t.damageMultiplier||3)),s.takeDamage(l),s.clearStatus();break;case"freeze":s.freeze(t.freezeDuration||2e3),s.clearStatus();break;case"explosion":l=Math.floor(i*(t.damageMultiplier||1.5));const h=t.explosionRadius||80;for(const c of a){if(!c.isAlive)continue;const d=c.getCenter(),m=d.x-n.x,f=d.y-n.y,u=Math.sqrt(m*m+f*f);if(u<=h){const y=1-u/h*.5,v=Math.floor(l*y);c.takeDamage(v),o.includes(c)||o.push(c),c.status==="oil"&&c.clearStatus()}}s.clearStatus();break}return{type:e,config:t,position:n,damage:l,affectedEnemies:o}}getReactionIcon(e){return P[e].icon}getReactionName(e){return P[e].name}getReactionColor(e){return P[e].color}}class he{constructor(){r(this,"spellUsageCounts",new Map);this.resetUsageCounts()}resetUsageCounts(){this.spellUsageCounts.clear();for(const e of Object.keys(w))this.spellUsageCounts.set(e,0)}canUseSpell(e){const t=w[e];return(this.spellUsageCounts.get(e)||0)<t.cooldown}getRemainingUses(e){const t=w[e],s=this.spellUsageCounts.get(e)||0;return Math.max(0,t.cooldown-s)}castSpell(e,t,s){if(!this.canUseSpell(e))return null;const i=w[e],a=[];let n=0;switch(e){case"meteor":for(const l of s){if(!l.isAlive)continue;const h=l.getCenter(),c=h.x-t.x,d=h.y-t.y,m=Math.sqrt(c*c+d*d);if(m<=i.radius){const f=1-m/i.radius*.5,u=Math.floor((i.damage||0)*f);l.takeDamage(u),n+=u,a.push(l),l.applyStatus("fire")}}break;case"blizzard":for(const l of s)l.isAlive&&(l.applySlow(i.slowDuration||3e3,i.slowMultiplier||.4),i.appliesStatus&&l.applyStatus(i.appliesStatus),a.push(l));break;case"oil_bomb":for(const l of s){if(!l.isAlive)continue;const h=l.getCenter(),c=h.x-t.x,d=h.y-t.y;if(Math.sqrt(c*c+d*d)<=i.radius){const f=i.damage||0;l.takeDamage(f),n+=f,i.appliesStatus&&l.applyStatus(i.appliesStatus),a.push(l)}}break}const o=this.spellUsageCounts.get(e)||0;return this.spellUsageCounts.set(e,o+1),{spellType:e,position:t,affectedEnemies:a,totalDamage:n}}drawSpellPreview(e,t,s){const i=w[t];t!=="blizzard"&&(e.beginPath(),e.arc(s.x,s.y,i.radius,0,Math.PI*2),e.fillStyle=`${i.color}30`,e.fill(),e.strokeStyle=i.color,e.lineWidth=2,e.stroke(),e.font="24px sans-serif",e.textAlign="center",e.textBaseline="middle",e.fillStyle="#fff",e.fillText(i.icon,s.x,s.y))}drawSpellEffect(e,t,s,i){const a=w[t];switch(t){case"meteor":const n=a.radius*(1+i*.3);e.beginPath(),e.arc(s.x,s.y,n*i,0,Math.PI*2),e.strokeStyle=`rgba(255, 100, 50, ${1-i})`,e.lineWidth=5,e.stroke(),i<.5&&(e.beginPath(),e.arc(s.x,s.y,20*(1-i*2),0,Math.PI*2),e.fillStyle=`rgba(255, 200, 50, ${1-i*2})`,e.fill());break;case"blizzard":e.fillStyle=`rgba(135, 206, 235, ${.3*(1-i)})`,e.fillRect(0,0,e.canvas.width,e.canvas.height);break;case"oil_bomb":const o=a.radius*i;e.beginPath(),e.arc(s.x,s.y,o,0,Math.PI*2),e.fillStyle=`rgba(50, 30, 20, ${.5*(1-i)})`,e.fill(),e.strokeStyle=`rgba(100, 60, 30, ${1-i})`,e.lineWidth=3,e.stroke();break}}}class ce{constructor(){r(this,"deck");r(this,"upgrades");r(this,"cardIdCounter");this.cardIdCounter=0,this.deck=this.createInitialDeck(),this.upgrades=this.createInitialUpgrades()}createInitialDeck(){return[{id:this.generateCardId(),cardType:"tower",element:"physical",count:3}]}createInitialUpgrades(){return{damageBonus:{physical:1,fire:1,ice:1,lightning:1,poison:1,light:1,arcane:1},rangeBonus:0,fireRateBonus:1,allDamageBonus:1}}generateCardId(){return`deck-card-${++this.cardIdCounter}`}addCard(e,t,s){const i=this.deck.find(a=>e==="tower"?a.cardType==="tower"&&a.element===t:a.cardType==="spell"&&a.spellType===s);i?i.count++:this.deck.push({id:this.generateCardId(),cardType:e,element:t,spellType:s,count:1})}drawHand(e=C.HAND_SIZE){const t=[];if(this.deck.reduce((a,n)=>a+n.count,0)===0)return console.warn("ãƒ‡ãƒƒã‚­ãŒç©ºã§ã™"),t;const i=this.deck.filter(a=>a.cardType==="tower");if(i.length>0){const a=this.weightedRandomSelect(i);a&&t.push(this.createCardFromDeckCard(a))}for(;t.length<e;){const a=this.weightedRandomSelect(this.deck);if(a)t.push(this.createCardFromDeckCard(a));else break}return t}weightedRandomSelect(e){const t=e.reduce((i,a)=>i+a.count,0);if(t===0)return null;let s=Math.random()*t;for(const i of e)if(s-=i.count,s<=0)return i;return e[e.length-1]}createCardFromDeckCard(e){return e.cardType==="tower"&&e.element?new k("tower",{x:0,y:0},e.element):e.cardType==="spell"&&e.spellType?new k("spell",{x:0,y:0},void 0,e.spellType):new k("tower",{x:0,y:0},"fire")}applyUpgrade(e,t,s){switch(e){case"damage":s&&(this.upgrades.damageBonus[s]*=1+t);break;case"range":this.upgrades.rangeBonus+=t;break;case"fire_rate":this.upgrades.fireRateBonus*=1-t;break;case"all_damage":this.upgrades.allDamageBonus*=1+t;break}}getDamageMultiplier(e){return this.upgrades.damageBonus[e]*this.upgrades.allDamageBonus}getRangeBonus(){return this.upgrades.rangeBonus}getFireRateMultiplier(){return this.upgrades.fireRateBonus}getDeck(){return[...this.deck]}getUpgrades(){return{...this.upgrades}}getCardCount(e,t,s){const i=this.deck.find(a=>e==="tower"?a.cardType==="tower"&&a.element===t:a.cardType==="spell"&&a.spellType===s);return(i==null?void 0:i.count)??0}getTotalCardCount(){return this.deck.reduce((e,t)=>e+t.count,0)}reset(){this.deck=this.createInitialDeck(),this.upgrades=this.createInitialUpgrades()}addStarterCard(e){this.addCard("tower",e)}}class de{constructor(){r(this,"tokens");r(this,"interestRate");r(this,"maxInterest");r(this,"artifacts");this.tokens=S.INITIAL_TOKENS,this.interestRate=S.INTEREST_RATE,this.maxInterest=S.MAX_INTEREST,this.artifacts=new Map}getTokens(){return this.tokens}addTokens(e){this.tokens+=e}spendTokens(e){return this.tokens<e?!1:(this.tokens-=e,!0)}canAfford(e){return this.tokens>=e}tryEnemyDrop(){if(Math.random()<S.ENEMY_DROP_CHANCE){const e=S.ENEMY_DROP_AMOUNT;return this.tokens+=e,e}return 0}applyWaveClearBonus(){const e=S.WAVE_CLEAR_BONUS,t=Math.min(Math.floor(this.tokens*this.interestRate),this.maxInterest);return this.tokens+=e+t,{base:e,interest:t,total:e+t}}addArtifact(e){const t=B[e],s=this.artifacts.get(e)||0;this.artifacts.set(e,s+t.value),e==="interest_rate_up"&&(this.interestRate+=t.value)}getDamageMultiplier(e){let t=1;if(t+=this.artifacts.get("all_damage_up")||0,e)switch(e){case"fire":t+=this.artifacts.get("fire_damage_up")||0;break;case"ice":t+=this.artifacts.get("ice_damage_up")||0;break;case"lightning":t+=this.artifacts.get("lightning_damage_up")||0;break}return t}getTowerHPMultiplier(){return 1+(this.artifacts.get("tower_hp_up")||0)}getShopExpansion(){return Math.floor(this.artifacts.get("expansion_pack")||0)}getRarityBonus(){return this.artifacts.get("vip_membership")||0}hasRecycleBin(){return(this.artifacts.get("recycle_bin")||0)>0}getRecycleTokens(e){return this.hasRecycleBin()?e?S.RECYCLE_TOKEN_BASE+5:S.RECYCLE_TOKEN_BASE:0}getArtifacts(){return new Map(this.artifacts)}getArtifactCount(){return this.artifacts.size}reset(){this.tokens=S.INITIAL_TOKENS,this.interestRate=S.INTEREST_RATE,this.artifacts.clear()}}class pe{constructor(){r(this,"currentItems");r(this,"itemIdCounter");r(this,"handSizeUpsPurchased");r(this,"rerollTokens");this.currentItems=[],this.itemIdCounter=0,this.handSizeUpsPurchased=0,this.rerollTokens=0}generateItemId(){return`shop-item-${++this.itemIdCounter}`}generateShopItems(e,t=0,s=0){this.currentItems=[];const i=S.SHOP_ITEMS_COUNT+t,a=["new_card"],n=["new_card","base_repair"];e>=2&&(n.push("reroll_token"),n.push("expansion_pack")),e>=3&&(n.push("tower_upgrade"),n.push("vip_membership"),n.push("recycle_bin")),e>=4&&this.handSizeUpsPurchased<2&&n.push("hand_size_up"),e>=5&&n.push("artifact");for(const h of a)this.currentItems.push(this.createItem(h,e,s));let o=0;const l=50;for(;this.currentItems.length<i&&o<l;){o++;const h=n[Math.floor(Math.random()*n.length)],c=this.currentItems.filter(d=>d.type===h).length;h==="new_card"&&c>=2||h!=="new_card"&&c>=1||this.currentItems.push(this.createItem(h,e,s))}for(;this.currentItems.length<i;)this.currentItems.push(this.createItem("new_card",e,s));return this.currentItems}createItem(e,t,s=0){const i=K[e];switch(e){case"new_card":return this.createNewCardItem(i);case"hand_size_up":return this.createHandSizeUpItem(i);case"reroll_token":return this.createRerollTokenItem(i);case"base_repair":return this.createBaseRepairItem(i);case"artifact":return this.createArtifactItem(i);case"tower_upgrade":return this.createTowerUpgradeItem(i);case"expansion_pack":return this.createExpansionPackItem(i);case"vip_membership":return this.createVIPMembershipItem(i);case"recycle_bin":return this.createRecycleBinItem(i);default:return this.createNewCardItem(i)}}createNewCardItem(e){if(Math.random()<.2){const s=["meteor","blizzard","oil_bomb"],i=s[Math.floor(Math.random()*s.length)],a=w[i];return{id:this.generateItemId(),type:"new_card",name:`${a.name}ã‚«ãƒ¼ãƒ‰`,description:a.description,icon:a.icon,price:e+20,cardType:"spell",spellType:i}}else if(Math.random()<.6){const i=T.physical;return{id:this.generateItemId(),type:"new_card",name:`${i.name}ã‚¿ãƒ¯ãƒ¼`,description:"ã‚·ãƒ³ãƒ—ãƒ«ã§å®‰å®šã—ãŸã‚¿ãƒ¯ãƒ¼",icon:i.icon,price:Math.floor(e*.8),cardType:"tower",element:"physical"}}else{const i=["fire","ice","lightning"],a=i[Math.floor(Math.random()*i.length)],n=T[a];return{id:this.generateItemId(),type:"new_card",name:`${n.name}ã‚¿ãƒ¯ãƒ¼`,description:`${n.name}å±žæ€§ã®ã‚¿ãƒ¯ãƒ¼ã‚«ãƒ¼ãƒ‰ï¼ˆã‚·ãƒŠã‚¸ãƒ¼åŠ¹æžœã‚ã‚Šï¼‰`,icon:n.icon,price:Math.floor(e*1.2),cardType:"tower",element:a}}}createHandSizeUpItem(e){const t=e+this.handSizeUpsPurchased*50;return{id:this.generateItemId(),type:"hand_size_up",name:"æ‰‹æœ­æ‹¡å¼µ",description:"æ‰‹æœ­ä¸Šé™+1ï¼ˆæ°¸ç¶šï¼‰",icon:"ðŸƒ",price:t}}createRerollTokenItem(e){return{id:this.generateItemId(),type:"reroll_token",name:"ãƒªãƒ­ãƒ¼ãƒ«ãƒˆãƒ¼ã‚¯ãƒ³",description:"æ‰‹æœ­ã‚’å¼•ãç›´ã›ã‚‹",icon:"ðŸ”„",price:e}}createBaseRepairItem(e){return{id:this.generateItemId(),type:"base_repair",name:"æ‹ ç‚¹ä¿®å¾©",description:"æ‹ ç‚¹HP+30",icon:"ðŸ”§",price:e}}createArtifactItem(e){const t=["fire_damage_up","ice_damage_up","lightning_damage_up","all_damage_up","tower_hp_up","interest_rate_up"],s=t[Math.floor(Math.random()*t.length)],i=B[s];return{id:this.generateItemId(),type:"artifact",name:i.name,description:i.description,icon:i.icon,price:e,artifactEffect:s,artifactValue:i.value}}createTowerUpgradeItem(e){const t=["physical","fire","ice","lightning"],s=t[Math.floor(Math.random()*t.length)],i=T[s];return{id:this.generateItemId(),type:"tower_upgrade",name:`${i.name}å¼·åŒ–`,description:`${i.name}ã‚¿ãƒ¯ãƒ¼ã®ãƒ€ãƒ¡ãƒ¼ã‚¸+10%`,icon:`â¬†ï¸${i.icon}`,price:e,element:s}}createExpansionPackItem(e){return{id:this.generateItemId(),type:"expansion_pack",name:"æ‹¡å¼µãƒ‘ãƒƒã‚¯",description:"ã‚·ãƒ§ãƒƒãƒ—é¸æŠžè‚¢+1ï¼ˆæ°¸ç¶šï¼‰",icon:"ðŸ“¦",price:e,artifactEffect:"expansion_pack"}}createVIPMembershipItem(e){return{id:this.generateItemId(),type:"vip_membership",name:"VIPãƒ¡ãƒ³ãƒãƒ¼ã‚·ãƒƒãƒ—",description:"ãƒ¬ã‚¢å‡ºç¾çŽ‡+15%ï¼ˆæ°¸ç¶šï¼‰",icon:"ðŸ‘‘",price:e,artifactEffect:"vip_membership"}}createRecycleBinItem(e){return{id:this.generateItemId(),type:"recycle_bin",name:"ãƒªã‚µã‚¤ã‚¯ãƒ«ãƒ“ãƒ³",description:"ã‚«ãƒ¼ãƒ‰ç ´æ£„æ™‚Tokenç²å¾—",icon:"â™»ï¸",price:e,artifactEffect:"recycle_bin"}}getCurrentItems(){return[...this.currentItems]}purchaseItem(e){const t=this.currentItems.findIndex(i=>i.id===e);if(t===-1)return null;const s=this.currentItems[t];return this.currentItems.splice(t,1),s.type==="hand_size_up"&&this.handSizeUpsPurchased++,s}rerollItems(e,t=0,s=0){return this.generateShopItems(e,t,s)}addRerollToken(){this.rerollTokens++}useRerollToken(){return this.rerollTokens>0?(this.rerollTokens--,!0):!1}getRerollTokens(){return this.rerollTokens}getHandSizeUpsPurchased(){return this.handSizeUpsPurchased}reset(){this.currentItems=[],this.handSizeUpsPurchased=0,this.rerollTokens=0}}class ge{constructor(){r(this,"items");r(this,"cardLayouts");r(this,"isVisible");r(this,"tokens");r(this,"waveBonus");r(this,"onItemPurchased");r(this,"onReroll");r(this,"onContinue");r(this,"CARD_WIDTH",130);r(this,"CARD_HEIGHT",180);r(this,"CARD_GAP",15);r(this,"rerollButtonBounds");r(this,"continueButtonBounds");this.items=[],this.cardLayouts=[],this.isVisible=!1,this.tokens=0,this.waveBonus=null,this.onItemPurchased=null,this.onReroll=null,this.onContinue=null,this.rerollButtonBounds={x:0,y:0,width:100,height:35},this.continueButtonBounds={x:0,y:0,width:150,height:40}}show(e,t,s){this.items=e,this.tokens=t,this.waveBonus=s||null,this.isVisible=!0,this.calculateLayouts()}hide(){this.isVisible=!1,this.items=[],this.cardLayouts=[],this.waveBonus=null}isShowing(){return this.isVisible}updateTokens(e){this.tokens=e,this.updateAffordability()}updateItems(e){this.items=e,this.calculateLayouts()}setOnItemPurchased(e){this.onItemPurchased=e}setOnReroll(e){this.onReroll=e}setOnContinue(e){this.onContinue=e}calculateLayouts(){this.cardLayouts=[];const e=this.items.length*this.CARD_WIDTH+(this.items.length-1)*this.CARD_GAP,t=(g.CANVAS_WIDTH-e)/2,s=180;for(let a=0;a<this.items.length;a++)this.cardLayouts.push({x:t+a*(this.CARD_WIDTH+this.CARD_GAP),y:s,width:this.CARD_WIDTH,height:this.CARD_HEIGHT,item:this.items[a],isHovered:!1,canAfford:this.tokens>=this.items[a].price});const i=s+this.CARD_HEIGHT+40;this.rerollButtonBounds={x:g.CANVAS_WIDTH/2-160,y:i,width:100,height:35},this.continueButtonBounds={x:g.CANVAS_WIDTH/2+10,y:i,width:150,height:40}}updateAffordability(){for(const e of this.cardLayouts)e.canAfford=this.tokens>=e.item.price}handleMouseMove(e,t){if(this.isVisible)for(let s=0;s<this.cardLayouts.length;s++){const i=this.cardLayouts[s];i.isHovered=this.isPointInRect(e,t,i)}}handleClick(e,t){if(!this.isVisible)return!1;for(const s of this.cardLayouts)if(this.isPointInRect(e,t,s)&&s.canAfford&&this.onItemPurchased)return this.onItemPurchased(s.item)&&(this.items=this.items.filter(a=>a.id!==s.item.id),this.calculateLayouts()),!0;return this.isPointInRect(e,t,this.rerollButtonBounds)?(this.onReroll&&this.onReroll()&&this.calculateLayouts(),!0):this.isPointInRect(e,t,this.continueButtonBounds)?(this.onContinue&&this.onContinue(),!0):!1}isPointInRect(e,t,s){return e>=s.x&&e<=s.x+s.width&&t>=s.y&&t<=s.y+s.height}draw(e,t,s){if(this.isVisible){e.fillStyle="rgba(0, 0, 0, 0.85)",e.fillRect(0,0,g.CANVAS_WIDTH,g.CANVAS_HEIGHT),e.font="bold 28px sans-serif",e.textAlign="center",e.textBaseline="middle",e.fillStyle="#ffd700",e.fillText("ðŸª SHOP ðŸª",g.CANVAS_WIDTH/2,40),this.waveBonus&&(e.font="14px sans-serif",e.fillStyle="#2ecc71",e.fillText(`ã‚¦ã‚§ãƒ¼ãƒ–ã‚¯ãƒªã‚¢ï¼ +${this.waveBonus.base} Token`+(this.waveBonus.interest>0?` (+${this.waveBonus.interest} åˆ©å­)`:""),g.CANVAS_WIDTH/2,70)),e.font="bold 20px sans-serif",e.fillStyle="#f1c40f",e.fillText(`ðŸ’° ${this.tokens} Token`,g.CANVAS_WIDTH/2,100),e.font="12px sans-serif",e.fillStyle="#888",e.fillText("ã‚¢ã‚¤ãƒ†ãƒ ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦è³¼å…¥",g.CANVAS_WIDTH/2,130);for(const i of this.cardLayouts)this.drawShopCard(e,i);this.drawRerollButton(e,t,s),this.drawContinueButton(e)}}drawShopCard(e,t){const{x:s,y:i,width:a,height:n,item:o,isHovered:l,canAfford:h}=t,c=l?1.05:1,d=a*c,m=n*c,f=s-(d-a)/2,u=i-(m-n)/2;e.save(),l&&h&&(e.shadowColor="#ffd700",e.shadowBlur=20),e.fillStyle=h?"#1a2a3a":"#1a1a1a",e.strokeStyle=l&&h?"#ffd700":h?"#4a90d9":"#555",e.lineWidth=l?3:2,this.drawRoundedRect(e,f,u,d,m,8),e.fill(),e.stroke(),e.restore(),h||(e.fillStyle="rgba(0, 0, 0, 0.5)",this.drawRoundedRect(e,f,u,d,m,8),e.fill()),e.font="32px sans-serif",e.textAlign="center",e.textBaseline="middle",e.fillStyle=h?"#fff":"#666",e.fillText(o.icon,f+d/2,u+45),e.font="bold 12px sans-serif",e.fillStyle=h?"#fff":"#666",e.fillText(o.name,f+d/2,u+85),e.font="10px sans-serif",e.fillStyle=h?"#aaa":"#555";const y=this.wrapText(o.description,d-16);for(let v=0;v<Math.min(y.length,2);v++)e.fillText(y[v],f+d/2,u+105+v*12);e.font="bold 14px sans-serif",e.fillStyle=h?"#f1c40f":"#e74c3c",e.fillText(`ðŸ’° ${o.price}`,f+d/2,u+m-20),l&&h&&(e.font="bold 11px sans-serif",e.fillStyle="#2ecc71",e.fillText("ã‚¯ãƒªãƒƒã‚¯ã§è³¼å…¥",f+d/2,u+m-40))}drawRerollButton(e,t,s){const{x:i,y:a,width:n,height:o}=this.rerollButtonBounds,l=this.tokens>=t||s>0;e.fillStyle=l?"#2c3e50":"#1a1a1a",e.strokeStyle=l?"#3498db":"#555",e.lineWidth=2,this.drawRoundedRect(e,i,a,n,o,5),e.fill(),e.stroke(),e.font="bold 11px sans-serif",e.textAlign="center",e.textBaseline="middle",e.fillStyle=l?"#fff":"#666",s>0?e.fillText(`ðŸ”„ (${s}å€‹)`,i+n/2,a+o/2):e.fillText(`ðŸ”„ ${t}ðŸ’°`,i+n/2,a+o/2)}drawContinueButton(e){const{x:t,y:s,width:i,height:a}=this.continueButtonBounds;e.fillStyle="#27ae60",e.strokeStyle="#2ecc71",e.lineWidth=2,this.drawRoundedRect(e,t,s,i,a,5),e.fill(),e.stroke(),e.font="bold 14px sans-serif",e.textAlign="center",e.textBaseline="middle",e.fillStyle="#fff",e.fillText("æ¬¡ã®ã‚¦ã‚§ãƒ¼ãƒ–ã¸ â–¶",t+i/2,s+a/2)}wrapText(e,t){if(e.length<=12)return[e];const s=Math.ceil(e.length/2);return[e.substring(0,s),e.substring(s)]}drawRoundedRect(e,t,s,i,a,n){e.beginPath(),e.moveTo(t+n,s),e.lineTo(t+i-n,s),e.quadraticCurveTo(t+i,s,t+i,s+n),e.lineTo(t+i,s+a-n),e.quadraticCurveTo(t+i,s+a,t+i-n,s+a),e.lineTo(t+n,s+a),e.quadraticCurveTo(t,s+a,t,s+a-n),e.lineTo(t,s+n),e.quadraticCurveTo(t,s,t+n,s),e.closePath()}}class me{constructor(){r(this,"progress");this.progress=this.loadProgress()}loadProgress(){try{const e=localStorage.getItem(E.STORAGE_KEY);if(e){const t=JSON.parse(e);if(this.isValidProgress(t))return this.migrateProgress(t)}}catch(e){console.warn("é€²æ—ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ:",e)}return this.createInitialProgress()}isValidProgress(e){if(!e||typeof e!="object")return!1;const t=e;return typeof t.rank=="number"&&typeof t.totalXP=="number"&&typeof t.highestWave=="number"&&typeof t.totalGamesPlayed=="number"&&Array.isArray(t.unlockedElements)&&Array.isArray(t.unlockedMaps)&&Array.isArray(t.unlockedStarterDecks)}migrateProgress(e){return typeof e.totalTokensEarned!="number"&&(e.totalTokensEarned=0),typeof e.permanentTokens!="number"&&(e.permanentTokens=0),e.permanentUpgrades||(e.permanentUpgrades=this.createInitialUpgradeState()),Array.isArray(e.matchHistory)||(e.matchHistory=[]),e}createInitialProgress(){return{rank:1,totalXP:0,highestWave:0,totalGamesPlayed:0,totalTokensEarned:0,permanentTokens:0,unlockedElements:[...z],unlockedMaps:["fortress"],unlockedStarterDecks:["balanced"],permanentUpgrades:this.createInitialUpgradeState(),matchHistory:[]}}createInitialUpgradeState(){return{starting_gold:0,base_hp:0,reroll_discount:0,rare_chance:0,tower_damage:0,tower_range:0,elemental_mastery:0,start_with_fire:0}}saveProgress(){try{localStorage.setItem(E.STORAGE_KEY,JSON.stringify(this.progress))}catch(e){console.error("é€²æ—ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ:",e)}}reset(){this.progress=this.createInitialProgress(),this.saveProgress()}addGameResult(e,t,s){const i=this.progress.rank;let a=e*E.XP_PER_WAVE;a+=t*E.XP_PER_KILL,s&&(a=Math.floor(a*E.XP_BONUS_MULTIPLIER)),this.progress.totalXP+=a,this.progress.totalGamesPlayed++,e>this.progress.highestWave&&(this.progress.highestWave=e);const n=this.calculateRank(this.progress.totalXP),o=n>i,l=[];if(o){for(let h=i+1;h<=n;h++){const c=b.find(d=>d.rank===h);if(c)for(const d of c.unlocks){const m=I[d];m&&(l.push(m),this.applyUnlock(m))}}this.progress.rank=n}return this.saveProgress(),{xpGained:a,newRank:n,rankUp:o,newUnlocks:l}}calculateRank(e){let t=1;for(const s of b)e>=s.xpRequired&&(t=s.rank);return Math.min(t,E.MAX_RANK)}applyUnlock(e){switch(e.type){case"element":e.unlockData&&!this.progress.unlockedElements.includes(e.unlockData)&&this.progress.unlockedElements.push(e.unlockData);break;case"map":e.unlockData&&!this.progress.unlockedMaps.includes(e.unlockData)&&this.progress.unlockedMaps.push(e.unlockData);break;case"starter_deck":e.unlockData&&!this.progress.unlockedStarterDecks.includes(e.unlockData)&&this.progress.unlockedStarterDecks.push(e.unlockData);break}}getRank(){return this.progress.rank}getRankConfig(){return b.find(e=>e.rank===this.progress.rank)||b[0]}getXPToNextRank(){const e=b.find(o=>o.rank===this.progress.rank),t=b.find(o=>o.rank===this.progress.rank+1);if(!t)return{current:this.progress.totalXP,required:this.progress.totalXP,progress:1};const s=(e==null?void 0:e.xpRequired)||0,i=t.xpRequired,a=this.progress.totalXP-s,n=i-s;return{current:a,required:n,progress:a/n}}getTotalXP(){return this.progress.totalXP}getHighestWave(){return this.progress.highestWave}getTotalGamesPlayed(){return this.progress.totalGamesPlayed}getUnlockedElements(){return[...this.progress.unlockedElements]}getUnlockedMaps(){return[...this.progress.unlockedMaps]}getUnlockedStarterDecks(){return[...this.progress.unlockedStarterDecks]}hasFeature(e){const t=I[e];return t?this.progress.rank>=t.requiredRank:!1}getAllUnlocks(){return Object.values(I).map(e=>({unlock:e,isUnlocked:this.progress.rank>=e.requiredRank}))}getNextUnlocks(){const e=b.find(t=>t.rank===this.progress.rank+1);return e?e.unlocks.map(t=>I[t]).filter(t=>t!==void 0):[]}resetProgress(){this.progress=this.createInitialProgress(),this.saveProgress()}getProgress(){return{...this.progress}}getPermanentTokens(){return this.progress.permanentTokens}getTotalTokensEarned(){return this.progress.totalTokensEarned}addPermanentTokens(e){this.progress.permanentTokens+=e,this.progress.totalTokensEarned+=e,this.saveProgress()}getUpgradeLevel(e){return this.progress.permanentUpgrades[e]}getUpgradeCost(e){const t=M[e],s=this.progress.permanentUpgrades[e];return s>=t.maxLevel?1/0:Math.floor(t.baseCost*Math.pow(t.costMultiplier,s))}canPurchaseUpgrade(e){const t=M[e];if(this.progress.permanentUpgrades[e]>=t.maxLevel)return!1;const i=this.getUpgradeCost(e);return this.progress.permanentTokens>=i}purchaseUpgrade(e){if(!this.canPurchaseUpgrade(e))return!1;const t=this.getUpgradeCost(e);return this.progress.permanentTokens-=t,this.progress.permanentUpgrades[e]++,this.saveProgress(),!0}getUpgradeEffect(e){const t=M[e],s=this.progress.permanentUpgrades[e];return t.effectPerLevel*s}getAllUpgrades(){return Object.keys(M).map(e=>({config:M[e],level:this.progress.permanentUpgrades[e],cost:this.getUpgradeCost(e),canPurchase:this.canPurchaseUpgrade(e)}))}addMatchHistory(e){const t={...e,id:`match_${Date.now()}_${Math.random().toString(36).substr(2,9)}`};this.progress.matchHistory.unshift(t),this.progress.matchHistory.length>L.MAX_ENTRIES&&(this.progress.matchHistory=this.progress.matchHistory.slice(0,L.MAX_ENTRIES)),this.saveProgress()}getMatchHistory(){return[...this.progress.matchHistory]}clearMatchHistory(){this.progress.matchHistory=[],this.saveProgress()}}class ue{constructor(e,t){r(this,"progressManager");r(this,"ctx");r(this,"isVisible");r(this,"onStartGame");r(this,"onOpenGrimoire");r(this,"onOpenUpgrades");r(this,"onOpenArchives");r(this,"onOpenSettings");r(this,"particles");r(this,"animationId");this.progressManager=e,this.ctx=t.getContext("2d"),this.isVisible=!0,this.particles=[],this.animationId=null,this.onStartGame=null,this.onOpenGrimoire=null,this.onOpenUpgrades=null,this.onOpenArchives=null,this.onOpenSettings=null,this.initParticles(),this.setupDOMListeners()}setupDOMListeners(){const e=document.getElementById("btn-new-game");e&&e.addEventListener("click",()=>{this.onStartGame&&this.onStartGame("balanced","fortress")});const t=document.getElementById("btn-grimoire");t&&t.addEventListener("click",()=>{this.onOpenGrimoire&&this.onOpenGrimoire()});const s=document.getElementById("btn-upgrades");s&&s.addEventListener("click",()=>{this.onOpenUpgrades&&this.onOpenUpgrades()});const i=document.getElementById("btn-archives");i&&i.addEventListener("click",()=>{this.onOpenArchives&&this.onOpenArchives()});const a=document.getElementById("btn-settings");a&&a.addEventListener("click",()=>{this.onOpenSettings&&this.onOpenSettings()})}initParticles(){this.particles=[];const e=50;for(let t=0;t<e;t++)this.particles.push(this.createParticle())}createParticle(){const e=["ðŸ”¥","â„ï¸","âš¡","âœ¨","ðŸ’«"];return{x:Math.random()*g.CANVAS_WIDTH,y:Math.random()*g.CANVAS_HEIGHT,vx:(Math.random()-.5)*.5,vy:(Math.random()-.5)*.5-.3,size:Math.random()*16+10,alpha:Math.random()*.5+.3,element:e[Math.floor(Math.random()*e.length)],rotation:Math.random()*Math.PI*2,rotationSpeed:(Math.random()-.5)*.02}}setOnStartGame(e){this.onStartGame=e}setOnOpenGrimoire(e){this.onOpenGrimoire=e}setOnOpenUpgrades(e){this.onOpenUpgrades=e}setOnOpenArchives(e){this.onOpenArchives=e}setOnOpenSettings(e){this.onOpenSettings=e}show(){this.isVisible=!0,this.updateDOMUI(),this.startAnimation()}hide(){this.isVisible=!1,this.stopAnimation()}isShowing(){return this.isVisible}updateDOMUI(){const e=this.progressManager.getRankConfig(),t=this.progressManager.getXPToNextRank(),s=document.getElementById("title-rank");s&&(s.textContent=`Rank ${e.rank}: ${e.name}`);const i=document.getElementById("title-xp-fill");i&&(i.style.width=`${t.progress*100}%`);const a=document.getElementById("title-xp-text");a&&(this.progressManager.getRank()>=10?a.textContent="MAX RANK":a.textContent=`${t.current} / ${t.required} XP`);const n=document.getElementById("title-games");n&&(n.textContent=String(this.progressManager.getTotalGamesPlayed()));const o=document.getElementById("title-highest");o&&(o.textContent=String(this.progressManager.getHighestWave()))}startAnimation(){if(this.animationId!==null)return;const e=()=>{this.isVisible&&(this.updateParticles(),this.drawBackground(),this.animationId=requestAnimationFrame(e))};e()}stopAnimation(){this.animationId!==null&&(cancelAnimationFrame(this.animationId),this.animationId=null)}updateParticles(){for(const e of this.particles)e.x+=e.vx,e.y+=e.vy,e.rotation+=e.rotationSpeed,e.y<-20&&(e.y=g.CANVAS_HEIGHT+20),e.y>g.CANVAS_HEIGHT+20&&(e.y=-20),e.x<-20&&(e.x=g.CANVAS_WIDTH+20),e.x>g.CANVAS_WIDTH+20&&(e.x=-20)}drawBackground(){const{CANVAS_WIDTH:e,CANVAS_HEIGHT:t}=g;this.ctx.fillStyle="#0a0a12",this.ctx.fillRect(0,0,e,t);const s=this.ctx.createRadialGradient(e/2,t/2,0,e/2,t/2,400);s.addColorStop(0,"rgba(74, 144, 217, 0.15)"),s.addColorStop(.5,"rgba(74, 144, 217, 0.05)"),s.addColorStop(1,"rgba(0, 0, 0, 0)"),this.ctx.fillStyle=s,this.ctx.fillRect(0,0,e,t),this.ctx.strokeStyle="rgba(74, 144, 217, 0.1)",this.ctx.lineWidth=1;const i=g.GRID_SIZE;for(let n=0;n<=e;n+=i)this.ctx.beginPath(),this.ctx.moveTo(n,0),this.ctx.lineTo(n,t),this.ctx.stroke();for(let n=0;n<=t;n+=i)this.ctx.beginPath(),this.ctx.moveTo(0,n),this.ctx.lineTo(e,n),this.ctx.stroke();for(const n of this.particles)this.ctx.save(),this.ctx.globalAlpha=n.alpha,this.ctx.translate(n.x,n.y),this.ctx.rotate(n.rotation),this.ctx.font=`${n.size}px sans-serif`,this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText(n.element,0,0),this.ctx.restore();const a=1+Math.sin(Date.now()/1e3)*.05;this.ctx.save(),this.ctx.translate(e/2,t/2),this.ctx.scale(a,a),this.ctx.font="80px sans-serif",this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.globalAlpha=.2,this.ctx.fillText("ðŸ°",0,0),this.ctx.restore()}}class fe{constructor(e){r(this,"currentScene");r(this,"sceneContainers");r(this,"canvas");r(this,"uiLayer");r(this,"onSceneChange");if(this.canvas=e,this.currentScene="title",this.sceneContainers=new Map,this.onSceneChange=null,this.uiLayer=document.getElementById("ui-layer"),!this.uiLayer)throw new Error("UI Layer element not found");this.registerSceneContainer("title","scene-title"),this.registerSceneContainer("game","scene-game"),this.registerSceneContainer("grimoire","scene-grimoire"),this.registerSceneContainer("upgrades","scene-upgrades"),this.registerSceneContainer("settings","scene-settings"),this.registerSceneContainer("archives","scene-archives"),this.initializeScene()}initializeScene(){this.sceneContainers.forEach(t=>{t.style.display="none",t.classList.remove("active")});const e=this.sceneContainers.get("title");e&&(e.style.display="flex",e.classList.add("active")),this.updateCanvasVisibility("title")}registerSceneContainer(e,t){const s=document.getElementById(t);s&&this.sceneContainers.set(e,s)}setOnSceneChange(e){this.onSceneChange=e}getCurrentScene(){return this.currentScene}changeScene(e){if(this.currentScene===e)return;const t=this.currentScene;this.currentScene=e,this.updateSceneVisibility(t,e),this.updateCanvasVisibility(e),this.onSceneChange&&this.onSceneChange(e)}updateSceneVisibility(e,t){const s=this.sceneContainers.get(e);s&&(s.classList.remove("active"),s.style.display="none");const i=this.sceneContainers.get(t);i&&(i.style.display="flex",requestAnimationFrame(()=>{i.classList.add("active")}))}updateCanvasVisibility(e){const t=e==="game"||e==="title";this.canvas.style.display=t?"block":"none",e==="title"?this.canvas.style.opacity="0.3":this.canvas.style.opacity="1"}isGameScene(){return this.currentScene==="game"}isTitleScene(){return this.currentScene==="title"}isMenuScene(){return["grimoire","upgrades","settings","archives"].includes(this.currentScene)}isArchivesScene(){return this.currentScene==="archives"}}class ye{constructor(){r(this,"data");this.data=this.loadData()}loadData(){try{const e=localStorage.getItem($.STORAGE_KEY);if(e){const t=JSON.parse(e);if(this.isValidData(t))return this.migrateData(t)}}catch(e){console.warn("å›³é‘‘ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ:",e)}return this.createInitialData()}isValidData(e){if(!e||typeof e!="object")return!1;const t=e;return typeof t.towers=="object"&&typeof t.enemies=="object"&&typeof t.artifacts=="object"}migrateData(e){const t=this.createInitialData();for(const s of Object.keys(t.towers))e.towers[s]||(e.towers[s]=t.towers[s]);for(const s of Object.keys(t.enemies))e.enemies[s]||(e.enemies[s]=t.enemies[s]);for(const s of Object.keys(t.artifacts))e.artifacts[s]||(e.artifacts[s]=t.artifacts[s]);return e}createInitialData(){const e={},t={},s={},i=["fire","ice","lightning","poison","light","arcane"];for(const o of i)e[o]={element:o,discovered:z.includes(o),timesPlaced:0,maxLevelReached:0,totalDamageDealt:0};const a=Object.keys(V);for(const o of a)t[o]={type:o,discovered:!1,timesEncountered:0,timesDefeated:0};const n=Object.keys(B);for(const o of n)s[o]={effect:o,discovered:!1,timesObtained:0};return{towers:e,enemies:t,artifacts:s}}saveData(){try{localStorage.setItem($.STORAGE_KEY,JSON.stringify(this.data))}catch(e){console.error("å›³é‘‘ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ:",e)}}reset(){this.data=this.createInitialData(),this.saveData()}recordTowerPlaced(e){const t=this.data.towers[e];t&&(t.discovered=!0,t.timesPlaced++,t.maxLevelReached===0&&(t.maxLevelReached=1),this.saveData())}recordTowerLevelUp(e,t){const s=this.data.towers[e];s&&t>s.maxLevelReached&&(s.maxLevelReached=t,this.saveData())}recordTowerDamage(e,t){const s=this.data.towers[e];s&&(s.totalDamageDealt+=t)}getTowerEntry(e){return this.data.towers[e]}getTowerDetail(e){return H[e]}getAllTowerEntries(){return Object.keys(this.data.towers).map(e=>({entry:this.data.towers[e],detail:H[e]}))}recordEnemyEncountered(e){const t=this.data.enemies[e];t&&(t.discovered=!0,t.timesEncountered++)}recordEnemyDefeated(e){const t=this.data.enemies[e];t&&t.timesDefeated++}getEnemyEntry(e){return this.data.enemies[e]}getEnemyDetail(e){return N[e]}getAllEnemyEntries(){return Object.keys(this.data.enemies).map(e=>({entry:this.data.enemies[e],detail:N[e]}))}recordArtifactObtained(e){const t=this.data.artifacts[e];t&&(t.discovered=!0,t.timesObtained++,this.saveData())}getArtifactEntry(e){return this.data.artifacts[e]}getArtifactDetail(e){return G[e]}getAllArtifactEntries(){return Object.keys(this.data.artifacts).map(e=>({entry:this.data.artifacts[e],detail:G[e]}))}getDiscoveryStats(){const e=Object.values(this.data.towers),t=Object.values(this.data.enemies),s=Object.values(this.data.artifacts),i={discovered:e.filter(o=>o.discovered).length,total:e.length},a={discovered:t.filter(o=>o.discovered).length,total:t.length},n={discovered:s.filter(o=>o.discovered).length,total:s.length};return{towers:i,enemies:a,artifacts:n,overall:{discovered:i.discovered+a.discovered+n.discovered,total:i.total+a.total+n.total}}}saveAll(){this.saveData()}}class Se{constructor(){r(this,"settings");r(this,"onSettingsChange");this.settings=this.loadSettings(),this.onSettingsChange=null}loadSettings(){try{const e=localStorage.getItem(U.STORAGE_KEY);if(e){const t=JSON.parse(e);if(this.isValidSettings(t))return{...D,...t}}}catch(e){console.warn("è¨­å®šãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ:",e)}return{...D}}isValidSettings(e){return!(!e||typeof e!="object")}saveSettings(){try{localStorage.setItem(U.STORAGE_KEY,JSON.stringify(this.settings)),this.onSettingsChange&&this.onSettingsChange(this.settings)}catch(e){console.error("è¨­å®šãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ:",e)}}setOnSettingsChange(e){this.onSettingsChange=e}reset(){this.settings={...D},this.saveSettings()}getSettings(){return{...this.settings}}getMasterVolume(){return this.settings.masterVolume}getSFXVolume(){return this.settings.sfxVolume}getBGMVolume(){return this.settings.bgmVolume}getEffectiveSFXVolume(){return this.settings.masterVolume/100*(this.settings.sfxVolume/100)}getEffectiveBGMVolume(){return this.settings.masterVolume/100*(this.settings.bgmVolume/100)}isShowDamageNumbers(){return this.settings.showDamageNumbers}isShowParticles(){return this.settings.showParticles}isShowSynergyPreview(){return this.settings.showSynergyPreview}setMasterVolume(e){this.settings.masterVolume=Math.max(0,Math.min(100,e)),this.saveSettings()}setSFXVolume(e){this.settings.sfxVolume=Math.max(0,Math.min(100,e)),this.saveSettings()}setBGMVolume(e){this.settings.bgmVolume=Math.max(0,Math.min(100,e)),this.saveSettings()}setShowDamageNumbers(e){this.settings.showDamageNumbers=e,this.saveSettings()}setShowParticles(e){this.settings.showParticles=e,this.saveSettings()}setShowSynergyPreview(e){this.settings.showSynergyPreview=e,this.saveSettings()}toggleShowDamageNumbers(){return this.settings.showDamageNumbers=!this.settings.showDamageNumbers,this.saveSettings(),this.settings.showDamageNumbers}toggleShowParticles(){return this.settings.showParticles=!this.settings.showParticles,this.saveSettings(),this.settings.showParticles}toggleShowSynergyPreview(){return this.settings.showSynergyPreview=!this.settings.showSynergyPreview,this.saveSettings(),this.settings.showSynergyPreview}}class _{constructor(e,t,s,i,a=60,n=.15,o=.98){r(this,"position");r(this,"velocity");r(this,"size");r(this,"color");r(this,"alpha");r(this,"life");r(this,"maxLife");r(this,"isActive");r(this,"gravity");r(this,"friction");r(this,"shrinkRate");this.position={...e},this.velocity={...t},this.size=s,this.color=i,this.alpha=1,this.life=a,this.maxLife=a,this.isActive=!0,this.gravity=n,this.friction=o,this.shrinkRate=s/a}update(){this.isActive&&(this.position.x+=this.velocity.x,this.position.y+=this.velocity.y,this.velocity.y+=this.gravity,this.velocity.x*=this.friction,this.velocity.y*=this.friction,this.life--,this.alpha=Math.max(0,this.life/this.maxLife),this.size=Math.max(0,this.size-this.shrinkRate*.5),(this.life<=0||this.size<=0)&&(this.isActive=!1))}draw(e){if(!this.isActive||this.alpha<=0)return;e.save(),e.globalAlpha=this.alpha;const t=e.createRadialGradient(this.position.x,this.position.y,0,this.position.x,this.position.y,this.size);t.addColorStop(0,this.color),t.addColorStop(.5,this.color),t.addColorStop(1,"transparent"),e.beginPath(),e.arc(this.position.x,this.position.y,this.size,0,Math.PI*2),e.fillStyle=t,e.fill(),e.restore()}}class ve{constructor(e=500){r(this,"particles");r(this,"maxParticles");this.particles=[],this.maxParticles=e}createDeathExplosion(e,t,s=15){for(let i=0;i<s&&!(this.particles.length>=this.maxParticles);i++){const a=Math.PI*2*i/s+(Math.random()-.5)*.5,n=3+Math.random()*5,o={x:Math.cos(a)*n,y:Math.sin(a)*n-2},l=4+Math.random()*6,h=30+Math.random()*30,c=new _(e,o,l,t,h,.2,.96);this.particles.push(c)}for(let i=0;i<s/2&&!(this.particles.length>=this.maxParticles);i++){const a=Math.random()*Math.PI*2,n=1+Math.random()*3,o={x:Math.cos(a)*n,y:Math.sin(a)*n},l=new _(e,o,2+Math.random()*2,"#ffffff",20+Math.random()*20,.05,.99);this.particles.push(l)}}createHitEffect(e,t,s=6){for(let i=0;i<s&&!(this.particles.length>=this.maxParticles);i++){const a=Math.random()*Math.PI*2,n=1+Math.random()*2,o={x:Math.cos(a)*n,y:Math.sin(a)*n},l=new _(e,o,2+Math.random()*3,t,15+Math.random()*15,.1,.95);this.particles.push(l)}}createSynergySparkle(e){const t=["#ffd700","#fff176","#ffeb3b"];for(let s=0;s<8&&!(this.particles.length>=this.maxParticles);s++){const i=Math.PI*2*s/8,a=2+Math.random()*2,n={x:Math.cos(i)*a,y:Math.sin(i)*a-1},o=t[Math.floor(Math.random()*t.length)],l=new _(e,n,3+Math.random()*2,o,25+Math.random()*15,.08,.97);this.particles.push(l)}}update(){for(const e of this.particles)e.update();this.particles=this.particles.filter(e=>e.isActive)}draw(e){for(const t of this.particles)t.draw(e)}getParticleCount(){return this.particles.length}clear(){this.particles=[]}}class we{constructor(e,t,s=!1,i="#ffffff"){r(this,"position");r(this,"damage");r(this,"isCritical");r(this,"color");r(this,"isActive");r(this,"velocity");r(this,"alpha");r(this,"scale");r(this,"life");r(this,"maxLife");this.position={...e},this.damage=t,this.isCritical=s,this.color=s?"#ffd700":i,this.isActive=!0,this.velocity={x:(Math.random()-.5)*2,y:-3-Math.random()*2},this.alpha=1,this.scale=s?1.5:1,this.life=s?60:45,this.maxLife=this.life}update(){if(this.isActive){if(this.position.x+=this.velocity.x,this.position.y+=this.velocity.y,this.velocity.y+=.1,this.velocity.x*=.95,this.life--,this.life<this.maxLife*.4&&(this.alpha=this.life/(this.maxLife*.4)),this.isCritical){const e=1-this.life/this.maxLife;e<.1?this.scale=1.5+e*5:e<.2?this.scale=2-(e-.1)*5:this.scale=1.5}this.life<=0&&(this.isActive=!1)}}draw(e){if(!this.isActive||this.alpha<=0)return;e.save(),e.globalAlpha=this.alpha;const t=this.damage.toString(),s=this.isCritical?20*this.scale:14*this.scale;e.font=`bold ${s}px 'Segoe UI', sans-serif`,e.textAlign="center",e.textBaseline="middle",this.isCritical&&(e.shadowColor="#ffd700",e.shadowBlur=15,e.fillStyle="#fff",e.fillText(t,this.position.x,this.position.y),e.font="bold 10px 'Segoe UI', sans-serif",e.fillStyle="#ff6b6b",e.shadowColor="#ff0000",e.shadowBlur=5,e.fillText("CRITICAL!",this.position.x,this.position.y-s/2-8)),e.shadowColor="rgba(0, 0, 0, 0.8)",e.shadowBlur=4,e.shadowOffsetX=1,e.shadowOffsetY=1,e.strokeStyle="#000",e.lineWidth=3,e.strokeText(t,this.position.x,this.position.y),e.fillStyle=this.color,e.fillText(t,this.position.x,this.position.y),e.restore()}}class Te{constructor(e,t,s="#ffffff"){r(this,"position");r(this,"text");r(this,"color");r(this,"isActive");r(this,"velocity");r(this,"alpha");r(this,"scale");r(this,"life");r(this,"maxLife");this.position={...e},this.text=t,this.color=s,this.isActive=!0,this.velocity={x:0,y:-2},this.alpha=1,this.scale=.5,this.life=80,this.maxLife=this.life}update(){if(!this.isActive)return;this.position.x+=this.velocity.x,this.position.y+=this.velocity.y,this.velocity.y*=.95,this.life--;const e=1-this.life/this.maxLife;e<.15?this.scale=.5+e*5:e<.3?this.scale=1.25-(e-.15)*2:this.scale=.95+Math.sin(e*10)*.05,this.life<this.maxLife*.3&&(this.alpha=this.life/(this.maxLife*.3)),this.life<=0&&(this.isActive=!1)}draw(e){if(!this.isActive||this.alpha<=0)return;e.save(),e.globalAlpha=this.alpha;const t=24*this.scale;e.font=`bold ${t}px 'Segoe UI', sans-serif`,e.textAlign="center",e.textBaseline="middle",e.shadowColor=this.color,e.shadowBlur=20,e.strokeStyle="#000",e.lineWidth=4,e.strokeText(this.text,this.position.x,this.position.y),e.fillStyle=this.color,e.fillText(this.text,this.position.x,this.position.y),e.restore()}}class Ce{constructor(e=50){r(this,"popups");r(this,"textPopups");r(this,"maxPopups");this.popups=[],this.textPopups=[],this.maxPopups=e}createPopup(e,t,s=!1,i="#ffffff"){this.popups.length>=this.maxPopups&&this.popups.shift();const a={x:e.x+(Math.random()-.5)*20,y:e.y-10},n=new we(a,t,s,i);this.popups.push(n)}createTextPopup(e,t,s="#ffffff"){this.textPopups.length>=this.maxPopups/2&&this.textPopups.shift();const i=new Te(e,t,s);this.textPopups.push(i)}update(){for(const e of this.popups)e.update();for(const e of this.textPopups)e.update();this.popups=this.popups.filter(e=>e.isActive),this.textPopups=this.textPopups.filter(e=>e.isActive)}draw(e){for(const t of this.popups)t.draw(e);for(const t of this.textPopups)t.draw(e)}clear(){this.popups=[],this.textPopups=[]}}class be{constructor(e){r(this,"canvas");r(this,"ctx");r(this,"pathSystem");r(this,"gridSystem");r(this,"handSystem");r(this,"synergySystem");r(this,"reactionSystem");r(this,"spellSystem");r(this,"deckManager");r(this,"economyManager");r(this,"shopManager");r(this,"shopUI");r(this,"progressManager");r(this,"titleScreen");r(this,"sceneManager");r(this,"encyclopediaManager");r(this,"settingsManager");r(this,"currentGrimoireTab");r(this,"currentHandSize");r(this,"totalEnemiesKilledThisGame");r(this,"totalTokensEarnedThisGame");r(this,"gameStartTime");r(this,"towerUsageCount");r(this,"particleSystem");r(this,"damagePopupManager");r(this,"enemies");r(this,"towers");r(this,"projectiles");r(this,"activeSpellAnimations");r(this,"gameState");r(this,"lastTime");r(this,"animationFrameId");r(this,"waveNumber");r(this,"baseHP");r(this,"maxBaseHP");r(this,"isPaused",!1);r(this,"pauseOverlay");r(this,"pauseButton");r(this,"resumeButton");r(this,"returnTitleButton");r(this,"draggingCard");r(this,"dragPosition");r(this,"hoverCell");r(this,"startButton");r(this,"waveCountElement");r(this,"enemyCountElement");r(this,"towerCountElement");r(this,"baseHPElement");r(this,"synergyListElement");r(this,"deckTotalElement");r(this,"upgradeListElement");r(this,"tokenDisplayElement");r(this,"enemiesSpawned");r(this,"enemiesPerWave");r(this,"spawnInterval");r(this,"lastSpawnTime");r(this,"enemiesKilledThisWave");r(this,"lastCardRefillKillCount");r(this,"isBossWave",!1);r(this,"bossWarningStartTime",0);r(this,"showBossWarning",!1);r(this,"bossSpawned",!1);this.canvas=e;const t=e.getContext("2d");if(!t)throw new Error("Canvas 2D context ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ");this.ctx=t,this.pathSystem=new ae,this.gridSystem=new ne(this.pathSystem),this.synergySystem=new oe,this.reactionSystem=new le,this.spellSystem=new he,this.progressManager=new me,this.sceneManager=new fe(e),this.titleScreen=new ue(this.progressManager,e),this.encyclopediaManager=new ye,this.settingsManager=new Se,this.currentGrimoireTab="towers",this.setupTitleScreenCallbacks(),this.setupSceneManagerCallbacks(),this.setupSettingsCallbacks(),this.deckManager=new ce,this.economyManager=new de,this.shopManager=new pe,this.shopUI=new ge,this.currentHandSize=C.HAND_SIZE,this.totalEnemiesKilledThisGame=0,this.totalTokensEarnedThisGame=0,this.gameStartTime=0,this.towerUsageCount=new Map,this.handSystem=new re("hand-container"),this.particleSystem=new ve(500),this.damagePopupManager=new Ce(50),this.enemies=[],this.towers=[],this.projectiles=[],this.activeSpellAnimations=[],this.gameState="idle",this.lastTime=0,this.animationFrameId=null,this.waveNumber=1,this.hoverCell=null,this.draggingCard=null,this.dragPosition=null,this.maxBaseHP=100,this.baseHP=this.maxBaseHP,this.enemiesSpawned=0,this.enemiesPerWave=16,this.spawnInterval=800,this.lastSpawnTime=0,this.enemiesKilledThisWave=0,this.lastCardRefillKillCount=0,this.startButton=document.getElementById("start-button"),this.waveCountElement=document.getElementById("wave-count"),this.enemyCountElement=document.getElementById("enemy-count"),this.towerCountElement=document.getElementById("tower-count"),this.baseHPElement=document.getElementById("base-hp"),this.synergyListElement=document.getElementById("synergy-list"),this.deckTotalElement=document.getElementById("deck-total"),this.upgradeListElement=document.getElementById("upgrade-list"),this.tokenDisplayElement=document.getElementById("token-count"),this.pauseOverlay=document.getElementById("pause-overlay"),this.pauseButton=document.getElementById("pause-button"),this.resumeButton=document.getElementById("resume-button"),this.returnTitleButton=document.getElementById("return-title-button"),this.setupEventListeners(),this.setupHandSystemCallbacks(),this.setupShopUICallbacks(),this.titleScreen.show(),this.draw(),this.updateUI()}setupTitleScreenCallbacks(){this.titleScreen.setOnStartGame((e,t)=>{this.sceneManager.changeScene("game"),this.startNewGame()}),this.titleScreen.setOnOpenGrimoire(()=>{this.sceneManager.changeScene("grimoire"),this.populateGrimoire()}),this.titleScreen.setOnOpenUpgrades(()=>{this.sceneManager.changeScene("upgrades"),this.populateUpgrades()}),this.titleScreen.setOnOpenArchives(()=>{this.sceneManager.changeScene("archives"),this.populateArchives()}),this.titleScreen.setOnOpenSettings(()=>{this.sceneManager.changeScene("settings")})}setupSceneManagerCallbacks(){this.sceneManager.setOnSceneChange(e=>{this.handleSceneChange(e)}),this.setupMenuBackButtons()}setupMenuBackButtons(){var t,s,i,a,n;const e=()=>{this.sceneManager.changeScene("title"),this.titleScreen.show()};(t=document.getElementById("btn-grimoire-back"))==null||t.addEventListener("click",e),(s=document.getElementById("btn-upgrades-back"))==null||s.addEventListener("click",e),(i=document.getElementById("btn-archives-back"))==null||i.addEventListener("click",e),(a=document.getElementById("btn-settings-back"))==null||a.addEventListener("click",e),document.querySelectorAll(".grimoire-tab").forEach(o=>{o.addEventListener("click",l=>{const h=l.target,c=h.dataset.tab;c&&(this.currentGrimoireTab=c,document.querySelectorAll(".grimoire-tab").forEach(d=>d.classList.remove("active")),h.classList.add("active"),this.populateGrimoireGrid())})}),(n=document.getElementById("btn-reset-progress"))==null||n.addEventListener("click",()=>{confirm(`æœ¬å½“ã«é€²æ—ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚

ä»¥ä¸‹ã®ãƒ‡ãƒ¼ã‚¿ãŒå‰Šé™¤ã•ã‚Œã¾ã™:
ãƒ»ãƒ©ãƒ³ã‚¯ã¨XP
ãƒ»å›³é‘‘ã®ç™ºè¦‹ãƒ‡ãƒ¼ã‚¿
ãƒ»å…¨ã¦ã®è¨­å®š`)&&(this.progressManager.reset(),this.encyclopediaManager.reset(),this.settingsManager.reset(),this.titleScreen.show(),alert("é€²æ—ãŒãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã—ãŸã€‚"))})}setupSettingsCallbacks(){const e=this.settingsManager.getSettings(),t=document.getElementById("slider-master"),s=document.getElementById("slider-sfx"),i=document.getElementById("slider-bgm");t&&(t.value=String(e.masterVolume),document.getElementById("value-master").textContent=String(e.masterVolume),t.addEventListener("input",l=>{const h=Number(l.target.value);this.settingsManager.setMasterVolume(h),document.getElementById("value-master").textContent=String(h)})),s&&(s.value=String(e.sfxVolume),document.getElementById("value-sfx").textContent=String(e.sfxVolume),s.addEventListener("input",l=>{const h=Number(l.target.value);this.settingsManager.setSFXVolume(h),document.getElementById("value-sfx").textContent=String(h)})),i&&(i.value=String(e.bgmVolume),document.getElementById("value-bgm").textContent=String(e.bgmVolume),i.addEventListener("input",l=>{const h=Number(l.target.value);this.settingsManager.setBGMVolume(h),document.getElementById("value-bgm").textContent=String(h)}));const a=document.getElementById("toggle-damage"),n=document.getElementById("toggle-particles"),o=document.getElementById("toggle-synergy");a&&(a.classList.toggle("active",e.showDamageNumbers),a.addEventListener("click",()=>{const l=this.settingsManager.toggleShowDamageNumbers();a.classList.toggle("active",l)})),n&&(n.classList.toggle("active",e.showParticles),n.addEventListener("click",()=>{const l=this.settingsManager.toggleShowParticles();n.classList.toggle("active",l)})),o&&(o.classList.toggle("active",e.showSynergyPreview),o.addEventListener("click",()=>{const l=this.settingsManager.toggleShowSynergyPreview();o.classList.toggle("active",l)}))}handleSceneChange(e){switch(e){case"title":this.animationFrameId!==null&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null),this.titleScreen.show();break;case"game":this.titleScreen.hide();break;case"grimoire":case"upgrades":case"settings":case"archives":this.titleScreen.hide();break}}populateGrimoire(){this.updateDiscoveryStats(),this.populateGrimoireGrid(),this.clearGrimoireDetail()}updateDiscoveryStats(){const e=document.getElementById("discovery-stats");if(!e)return;const t=this.encyclopediaManager.getDiscoveryStats();e.innerHTML=`
      <span>ðŸ° ã‚¿ãƒ¯ãƒ¼: ${t.towers.discovered}/${t.towers.total}</span>
      <span>ðŸ‘¹ æ•µ: ${t.enemies.discovered}/${t.enemies.total}</span>
      <span>âœ¨ ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆ: ${t.artifacts.discovered}/${t.artifacts.total}</span>
      <span style="color: #ffd700;">ðŸ“Š å…¨ä½“: ${Math.round(t.overall.discovered/t.overall.total*100)}%</span>
    `}populateGrimoireGrid(){const e=document.getElementById("grimoire-grid");if(e)switch(e.innerHTML="",this.currentGrimoireTab){case"towers":this.populateTowerGrid(e);break;case"enemies":this.populateEnemyGrid(e);break;case"artifacts":this.populateArtifactGrid(e);break}}populateTowerGrid(e){const t=this.encyclopediaManager.getAllTowerEntries();for(const{entry:s,detail:i}of t){const a=document.createElement("div");a.className=`grimoire-item ${s.discovered?"":"locked"}`,s.discovered?(a.innerHTML=`
          <div class="grimoire-icon">${i.icon}</div>
          <div class="grimoire-name">${i.name}</div>
          <div class="grimoire-stats">é…ç½®: ${s.timesPlaced}å›ž / æœ€é«˜Lv${s.maxLevelReached}</div>
        `,a.addEventListener("click",()=>this.showTowerDetail(s.element))):a.innerHTML=`
          <div class="grimoire-icon">â“</div>
          <div class="grimoire-name">Unknown</div>
          <div class="grimoire-stats">æœªç™ºè¦‹</div>
        `,e.appendChild(a)}}populateEnemyGrid(e){const t=this.encyclopediaManager.getAllEnemyEntries();for(const{entry:s,detail:i}of t){const a=document.createElement("div");a.className=`grimoire-item ${s.discovered?"":"locked"}`,s.discovered?(a.innerHTML=`
          <div class="grimoire-icon">${i.icon}</div>
          <div class="grimoire-name">${i.name}</div>
          <div class="grimoire-stats">é­é‡: ${s.timesEncountered} / æ’ƒç ´: ${s.timesDefeated}</div>
        `,a.addEventListener("click",()=>this.showEnemyDetail(s.type))):a.innerHTML=`
          <div class="grimoire-icon">â“</div>
          <div class="grimoire-name">Unknown</div>
          <div class="grimoire-stats">æœªç™ºè¦‹</div>
        `,e.appendChild(a)}}populateArtifactGrid(e){const t=this.encyclopediaManager.getAllArtifactEntries();for(const{entry:s,detail:i}of t){const a=document.createElement("div");a.className=`grimoire-item ${s.discovered?"":"locked"}`,s.discovered?(a.innerHTML=`
          <div class="grimoire-icon">${i.icon}</div>
          <div class="grimoire-name">${i.name}</div>
          <div class="grimoire-stats">å…¥æ‰‹: ${s.timesObtained}å›ž</div>
        `,a.addEventListener("click",()=>this.showArtifactDetail(s.effect))):a.innerHTML=`
          <div class="grimoire-icon">â“</div>
          <div class="grimoire-name">Unknown</div>
          <div class="grimoire-stats">æœªç™ºè¦‹</div>
        `,e.appendChild(a)}}clearGrimoireDetail(){const e=document.getElementById("grimoire-detail");e&&(e.innerHTML=`
      <div class="detail-placeholder">
        ã‚¢ã‚¤ãƒ†ãƒ ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦è©³ç´°ã‚’è¡¨ç¤º
      </div>
    `)}showTowerDetail(e){const t=document.getElementById("grimoire-detail"),s=this.encyclopediaManager.getTowerEntry(e),i=this.encyclopediaManager.getTowerDetail(e);!t||!s||!i||(t.innerHTML=`
      <div class="detail-header">
        <div class="detail-icon" style="color: ${i.color};">${i.icon}</div>
        <div class="detail-title">
          <h3>${i.name}</h3>
          <p>${i.description}</p>
        </div>
      </div>
      <div class="detail-body">
        <div class="detail-section">
          <h4>ðŸ“Š åŸºæœ¬ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</h4>
          <div class="detail-stats">
            <div class="stat-item"><span class="stat-label">æ”»æ’ƒåŠ›:</span> <span class="stat-value">${i.baseStats.damage}</span></div>
            <div class="stat-item"><span class="stat-label">å°„ç¨‹:</span> <span class="stat-value">${i.baseStats.range}px</span></div>
            <div class="stat-item"><span class="stat-label">æ”»æ’ƒé–“éš”:</span> <span class="stat-value">${i.baseStats.fireRate}ms</span></div>
          </div>
        </div>
        <div class="detail-section">
          <h4>ðŸ“ˆ ã‚ãªãŸã®è¨˜éŒ²</h4>
          <div class="detail-stats">
            <div class="stat-item"><span class="stat-label">é…ç½®å›žæ•°:</span> <span class="stat-value">${s.timesPlaced}</span></div>
            <div class="stat-item"><span class="stat-label">æœ€é«˜ãƒ¬ãƒ™ãƒ«:</span> <span class="stat-value">Lv${s.maxLevelReached}</span></div>
            <div class="stat-item"><span class="stat-label">ç·ãƒ€ãƒ¡ãƒ¼ã‚¸:</span> <span class="stat-value">${s.totalDamageDealt.toLocaleString()}</span></div>
          </div>
        </div>
      </div>
      <div class="flavor-text">${i.flavorText}</div>
    `)}showEnemyDetail(e){const t=document.getElementById("grimoire-detail"),s=this.encyclopediaManager.getEnemyEntry(e),i=this.encyclopediaManager.getEnemyDetail(e);if(!t||!s||!i)return;const a=s.timesEncountered>0?Math.round(s.timesDefeated/s.timesEncountered*100):0;t.innerHTML=`
      <div class="detail-header">
        <div class="detail-icon" style="color: ${i.color};">${i.icon}</div>
        <div class="detail-title">
          <h3>${i.name}</h3>
          <p>${i.description}</p>
        </div>
      </div>
      <div class="detail-body">
        <div class="detail-section">
          <h4>ðŸ“Š åŸºæœ¬ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</h4>
          <div class="detail-stats">
            <div class="stat-item"><span class="stat-label">ä½“åŠ›:</span> <span class="stat-value">${i.baseStats.health}</span></div>
            <div class="stat-item"><span class="stat-label">é€Ÿåº¦:</span> <span class="stat-value">${i.baseStats.speed}</span></div>
            <div class="stat-item"><span class="stat-label">æ”»æ’ƒåŠ›:</span> <span class="stat-value">${i.baseStats.attackDamage}</span></div>
          </div>
          <p style="margin-top: 10px; color: #e74c3c;"><strong>å¼±ç‚¹:</strong> ${i.weakness}</p>
        </div>
        <div class="detail-section">
          <h4>ðŸ“ˆ ã‚ãªãŸã®è¨˜éŒ²</h4>
          <div class="detail-stats">
            <div class="stat-item"><span class="stat-label">é­é‡å›žæ•°:</span> <span class="stat-value">${s.timesEncountered}</span></div>
            <div class="stat-item"><span class="stat-label">æ’ƒç ´å›žæ•°:</span> <span class="stat-value">${s.timesDefeated}</span></div>
            <div class="stat-item"><span class="stat-label">æ’ƒç ´çŽ‡:</span> <span class="stat-value">${a}%</span></div>
          </div>
        </div>
      </div>
      <div class="flavor-text">${i.flavorText}</div>
    `}showArtifactDetail(e){const t=document.getElementById("grimoire-detail"),s=this.encyclopediaManager.getArtifactEntry(e),i=this.encyclopediaManager.getArtifactDetail(e);!t||!s||!i||(t.innerHTML=`
      <div class="detail-header">
        <div class="detail-icon">${i.icon}</div>
        <div class="detail-title">
          <h3>${i.name}</h3>
          <p>${i.description}</p>
        </div>
      </div>
      <div class="detail-body">
        <div class="detail-section">
          <h4>ðŸ“ˆ ã‚ãªãŸã®è¨˜éŒ²</h4>
          <div class="detail-stats">
            <div class="stat-item"><span class="stat-label">å…¥æ‰‹å›žæ•°:</span> <span class="stat-value">${s.timesObtained}</span></div>
          </div>
        </div>
      </div>
      <div class="flavor-text">${i.flavorText}</div>
    `)}populateUpgrades(){const e=document.getElementById("permanent-tokens"),t=document.getElementById("total-tokens-earned");e&&(e.textContent=String(this.progressManager.getPermanentTokens())),t&&(t.textContent=String(this.progressManager.getTotalTokensEarned()));const s=document.getElementById("upgrade-scene-list");if(!s)return;s.innerHTML="";const i=this.progressManager.getAllUpgrades();for(const{config:a,level:n,cost:o,canPurchase:l}of i){const h=n>=a.maxLevel,c=a.effectType==="percent"?`+${a.effectPerLevel*n}%`:`+${a.effectPerLevel*n}`,d=document.createElement("div");d.className=`upgrade-item ${h?"maxed":""}`,d.innerHTML=`
        <div class="upgrade-left">
          <div class="upgrade-icon">${a.icon}</div>
          <div class="upgrade-info">
            <div class="upgrade-name">${a.name}</div>
            <div class="upgrade-desc">${a.description}</div>
            <div class="upgrade-effect">ç¾åœ¨ã®åŠ¹æžœ: ${c}</div>
          </div>
        </div>
        <div class="upgrade-right">
          <div class="upgrade-level">Lv${n}/${a.maxLevel}</div>
          <button class="upgrade-buy-btn ${h?"maxed":""}" 
                  data-upgrade="${a.id}"
                  ${!l||h?"disabled":""}>
            ${h?"MAX":`ðŸ’° ${o}`}
          </button>
        </div>
      `;const m=d.querySelector(".upgrade-buy-btn");m&&!h&&m.addEventListener("click",()=>{this.handleUpgradePurchase(a.id)}),s.appendChild(d)}}handleUpgradePurchase(e){this.progressManager.purchaseUpgrade(e)&&this.populateUpgrades()}populateArchives(){const e=document.getElementById("archive-total-games"),t=document.getElementById("archive-highest-wave"),s=document.getElementById("archive-total-kills");e&&(e.textContent=String(this.progressManager.getTotalGamesPlayed())),t&&(t.textContent=String(this.progressManager.getHighestWave()));const i=this.progressManager.getMatchHistory(),a=i.reduce((o,l)=>o+l.enemiesKilled,0);s&&(s.textContent=String(a));const n=document.getElementById("match-list");if(n){if(n.innerHTML="",i.length===0){n.innerHTML='<div class="no-matches">ã¾ã ãƒ—ãƒ¬ã‚¤è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</div>';return}i.forEach((o,l)=>{const h=new Date(o.date),c=`${h.getFullYear()}/${h.getMonth()+1}/${h.getDate()} ${h.getHours()}:${String(h.getMinutes()).padStart(2,"0")}`,d=Math.floor(o.duration/60),m=o.duration%60,f=`${d}:${String(m).padStart(2,"0")}`,u=o.mainTowers.map(v=>this.getElementIcon(v)).join(""),y=document.createElement("div");y.className="match-item",y.innerHTML=`
        <div class="match-left">
          <div class="match-rank">#${l+1}</div>
          <div class="match-info">
            <div class="match-date">${c} (${f})</div>
            <div class="match-result">
              Wave <span class="match-wave">${o.waveReached}</span> åˆ°é” 
              / ${o.enemiesKilled} æ’ƒç ´
            </div>
          </div>
        </div>
        <div class="match-right">
          <div class="match-towers">${u||"â€”"}</div>
          <div class="match-score">
            <div class="match-score-label">ã‚¹ã‚³ã‚¢</div>
            <div class="match-score-value">${o.score.toLocaleString()}</div>
          </div>
        </div>
      `,n.appendChild(y)})}}getElementIcon(e){return{physical:"ðŸ¹",fire:"ðŸ”¥",ice:"â„ï¸",lightning:"âš¡",poison:"â˜ ï¸",light:"âœ¨",arcane:"ðŸ”®"}[e]||"â“"}startNewGame(){this.titleScreen.hide(),this.resetGameState(),this.gameStartTime=Date.now(),this.totalTokensEarnedThisGame=0,this.towerUsageCount.clear(),this.applyUnlockedFeatures(),this.applyPermanentUpgrades(),this.dealHandFromDeck(),this.gameState="idle",this.startButton.disabled=!1,this.startButton.textContent="Start Wave 1",this.draw(),this.updateUI()}resetGameState(){this.enemies=[],this.towers.forEach(e=>this.gridSystem.releaseCell(e.gridRow,e.gridCol)),this.towers=[],this.projectiles=[],this.activeSpellAnimations=[],this.particleSystem.clear(),this.damagePopupManager.clear(),this.waveNumber=1,this.baseHP=this.maxBaseHP,this.enemiesSpawned=0,this.enemiesPerWave=16,this.lastSpawnTime=0,this.enemiesKilledThisWave=0,this.lastCardRefillKillCount=0,this.totalEnemiesKilledThisGame=0,this.currentHandSize=C.HAND_SIZE,this.deckManager.reset(),this.economyManager.reset(),this.shopManager.reset(),this.synergySystem.calculateAndApplySynergies(this.towers)}applyUnlockedFeatures(){this.progressManager.hasFeature("feature_extra_hand")&&this.currentHandSize++,this.progressManager.hasFeature("feature_starting_bonus")&&this.economyManager.addTokens(50)}applyPermanentUpgrades(){const e=this.progressManager.getUpgradeEffect("starting_gold");e>0&&this.economyManager.addTokens(e);const t=this.progressManager.getUpgradeEffect("base_hp");t>0&&(this.maxBaseHP+=t,this.baseHP=this.maxBaseHP),this.progressManager.getUpgradeLevel("start_with_fire")>0&&this.deckManager.addStarterCard("fire");const i=this.progressManager.getUpgradeEffect("elemental_mastery");i>0&&(this.deckManager.applyUpgrade("damage",i/100,"fire"),this.deckManager.applyUpgrade("damage",i/100,"ice"),this.deckManager.applyUpgrade("damage",i/100,"lightning"))}dealHandFromDeck(){const e=this.deckManager.drawHand(this.currentHandSize);this.handSystem.setHand(e)}onEnemyKilled(){this.enemiesKilledThisWave++,this.totalEnemiesKilledThisGame++;const e=S.ENEMIES_PER_CARD_REFILL;this.enemiesKilledThisWave-this.lastCardRefillKillCount>=e&&(this.lastCardRefillKillCount=this.enemiesKilledThisWave,this.tryRefillCard())}handleBossSkill(e,t,s){const i=e.useSkill(t);if(i)switch(i){case"summon":this.bossSummonMinions(e),this.settingsManager.isShowDamageNumbers()&&this.damagePopupManager.createTextPopup(e.position,"ðŸ‘¹ SUMMON!","#9b59b6");break;case"heal":const a=Math.floor(e.maxHealth*.1);e.heal(a),this.settingsManager.isShowDamageNumbers()&&this.damagePopupManager.createTextPopup(e.position,`+${a} HP`,"#2ecc71"),this.settingsManager.isShowParticles()&&this.particleSystem.createHitEffect(e.position,"#2ecc71",15);break;case"silence":if(s.length>0){const n=s[Math.floor(Math.random()*s.length)];n.applySilence(3e3),this.settingsManager.isShowDamageNumbers()&&this.damagePopupManager.createTextPopup(n.position,"ðŸ”‡ SILENCED!","#800080"),this.settingsManager.isShowParticles()&&this.particleSystem.createHitEffect(n.position,"#800080",10)}break}}bossSummonMinions(e){for(let t=0;t<3;t++){const i=this.pathSystem.getPath(e.routeIndex).slice(),a=new R(i,e.routeIndex,"normal",this.waveNumber,void 0,null),n=Math.PI*2/3*t;a.position.x=e.position.x+Math.cos(n)*40,a.position.y=e.position.y+Math.sin(n)*40,this.enemies.push(a)}}handleBossDefeat(e){const t=100+this.waveNumber*20;this.economyManager.addTokens(t),this.totalTokensEarnedThisGame+=t,this.settingsManager.isShowDamageNumbers()&&(this.damagePopupManager.createTextPopup({x:e.x,y:e.y-30},"ðŸ‘‘ BOSS DEFEATED!","#ffd700"),this.damagePopupManager.createTextPopup({x:e.x,y:e.y},`+${t}ðŸ’°`,"#f1c40f"));const s=["fire","ice","lightning"],i=s[Math.floor(Math.random()*s.length)];this.deckManager.addCard("tower",i),this.settingsManager.isShowDamageNumbers()&&this.damagePopupManager.createTextPopup({x:e.x,y:e.y+30},`+${this.getElementIcon(i)} ã‚«ãƒ¼ãƒ‰`,"#2ecc71")}tryRefillCard(){if(this.handSystem.getCards().length>=this.currentHandSize){const s=this.handSystem.discardOldestCard();if(s&&this.economyManager.hasRecycleBin()){const i=this.economyManager.getRecycleTokens(s.isSpellCard());this.economyManager.addTokens(i),this.damagePopupManager.createTextPopup({x:g.CANVAS_WIDTH/2,y:g.CANVAS_HEIGHT-80},`â™»ï¸ +${i}ðŸ’°`,"#2ecc71")}}const t=this.deckManager.drawHand(1);t.length>0&&(this.handSystem.addCard(t[0]),this.damagePopupManager.createTextPopup({x:g.CANVAS_WIDTH/2,y:g.CANVAS_HEIGHT-100},"ðŸƒ +1","#4a90d9"))}setupShopUICallbacks(){this.shopUI.setOnItemPurchased(e=>this.handleShopPurchase(e)),this.shopUI.setOnReroll(()=>this.handleShopReroll()),this.shopUI.setOnContinue(()=>{this.shopUI.hide(),this.prepareNextWave()})}handleShopPurchase(e){if(!this.economyManager.canAfford(e.price))return!1;switch(this.economyManager.spendTokens(e.price),e.type){case"new_card":e.cardType==="tower"&&e.element?this.deckManager.addCard("tower",e.element):e.cardType==="spell"&&e.spellType&&this.deckManager.addCard("spell",void 0,e.spellType);break;case"hand_size_up":this.currentHandSize<C.MAX_HAND_SIZE&&this.currentHandSize++;break;case"reroll_token":this.shopManager.addRerollToken();break;case"base_repair":this.baseHP=Math.min(this.maxBaseHP,this.baseHP+30);break;case"artifact":e.artifactEffect&&(this.economyManager.addArtifact(e.artifactEffect),this.encyclopediaManager.recordArtifactObtained(e.artifactEffect));break;case"tower_upgrade":e.element&&this.deckManager.applyUpgrade("damage",.1,e.element);break;case"expansion_pack":this.economyManager.addArtifact("expansion_pack"),this.encyclopediaManager.recordArtifactObtained("expansion_pack");break;case"vip_membership":this.economyManager.addArtifact("vip_membership"),this.encyclopediaManager.recordArtifactObtained("vip_membership");break;case"recycle_bin":this.economyManager.addArtifact("recycle_bin"),this.encyclopediaManager.recordArtifactObtained("recycle_bin");break}return this.shopManager.purchaseItem(e.id),this.shopUI.updateTokens(this.economyManager.getTokens()),this.updateUI(),!0}handleShopReroll(){const e=this.economyManager.getShopExpansion(),t=this.economyManager.getRarityBonus();if(this.shopManager.useRerollToken()){const s=this.shopManager.rerollItems(this.waveNumber,e,t);return this.shopUI.updateItems(s),!0}if(this.economyManager.canAfford(S.SHOP_REROLL_COST)){this.economyManager.spendTokens(S.SHOP_REROLL_COST);const s=this.shopManager.rerollItems(this.waveNumber,e,t);return this.shopUI.updateItems(s),this.shopUI.updateTokens(this.economyManager.getTokens()),!0}return!1}prepareNextWave(){this.gameState="idle",this.waveNumber++,this.startButton.disabled=!1,this.startButton.textContent=`Start Wave ${this.waveNumber}`,this.dealHandFromDeck(),this.draw(),this.updateUI()}setupEventListeners(){this.startButton.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),this.startWave()}),this.pauseButton.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),this.togglePause()}),this.resumeButton.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),this.resumeGame()}),this.returnTitleButton.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),this.returnToTitle()}),this.canvas.addEventListener("dragover",e=>{e.preventDefault(),e.dataTransfer&&(e.dataTransfer.dropEffect="move"),this.canvas.classList.add("drag-over");const t=this.canvas.getBoundingClientRect();this.dragPosition={x:e.clientX-t.left,y:e.clientY-t.top},this.hoverCell=this.gridSystem.getGridPosition(this.dragPosition.x,this.dragPosition.y),this.draw()}),this.canvas.addEventListener("dragleave",()=>{this.canvas.classList.remove("drag-over"),this.hoverCell=null,this.dragPosition=null,this.draw()}),this.canvas.addEventListener("drop",e=>{e.preventDefault(),this.canvas.classList.remove("drag-over"),this.hoverCell=null,this.dragPosition=null}),this.canvas.addEventListener("mousemove",e=>{const t=this.canvas.getBoundingClientRect(),s=e.clientX-t.left,i=e.clientY-t.top;if(this.sceneManager.isGameScene()){if(this.gameState==="shop"){this.shopUI.handleMouseMove(s,i),this.draw();return}this.draggingCard||(this.hoverCell=this.gridSystem.getGridPosition(s,i),this.gameState==="idle"&&this.draw())}}),this.canvas.addEventListener("click",e=>{const t=this.canvas.getBoundingClientRect(),s=e.clientX-t.left,i=e.clientY-t.top;this.sceneManager.isGameScene()&&this.gameState==="shop"&&(this.shopUI.handleClick(s,i),this.draw())}),this.canvas.addEventListener("mouseleave",()=>{this.draggingCard||(this.hoverCell=null,this.gameState==="idle"&&this.draw())})}setupHandSystemCallbacks(){this.handSystem.setOnCardDragStart(e=>{this.draggingCard=e}),this.handSystem.setOnCardDragEnd((e,t,s)=>{this.draggingCard=null,this.dragPosition=null;const i=this.canvas.getBoundingClientRect(),a=t-i.left,n=s-i.top;return a<0||a>g.CANVAS_WIDTH||n<0||n>g.CANVAS_HEIGHT?(this.draw(),!1):e.isSpellCard()&&e.spellType?this.handleSpellDrop(e,a,n):e.isTowerCard()&&e.element?this.handleTowerDrop(e,a,n):(this.draw(),!1)})}handleTowerDrop(e,t,s){const i=this.gridSystem.getGridPosition(t,s);if(!i||!e.element)return this.draw(),!1;const a=this.getTowerAt(i.row,i.col);if(a)return a.canMergeWith(e.element,1)?(a.levelUp(),this.encyclopediaManager.recordTowerLevelUp(a.element,a.level),this.particleSystem.createSynergySparkle(a.position),this.synergySystem.calculateAndApplySynergies(this.towers),this.updateUI(),this.draw(),!0):(this.draw(),!1);if(!this.gridSystem.canPlaceTower(i.row,i.col))return this.draw(),!1;const n=this.gridSystem.getCellCenter(i.row,i.col),o=new te(i.row,i.col,n,e.element);this.towers.push(o),this.gridSystem.occupyCell(i.row,i.col),this.encyclopediaManager.recordTowerPlaced(e.element);const l=this.towerUsageCount.get(e.element)||0;return this.towerUsageCount.set(e.element,l+1),this.synergySystem.calculateAndApplySynergies(this.towers),this.updateUI(),this.draw(),!0}handleSpellDrop(e,t,s){if(!e.spellType)return this.draw(),!1;if(this.gameState!=="playing")return this.damagePopupManager.createPopup({x:t,y:s},0,!1,"#ff6666"),this.draw(),!1;if(!this.spellSystem.canUseSpell(e.spellType))return this.damagePopupManager.createPopup({x:t,y:s},0,!1,"#ff6666"),this.draw(),!1;const i=this.spellSystem.castSpell(e.spellType,{x:t,y:s},this.enemies);if(i){this.activeSpellAnimations.push({spellType:e.spellType,position:{x:t,y:s},startTime:Date.now(),duration:1e3}),i.totalDamage>0&&this.damagePopupManager.createPopup({x:t,y:s},i.totalDamage,!1,w[e.spellType].color);const a=w[e.spellType];return this.damagePopupManager.createPopup({x:t,y:s-30},0,!1,a.color),this.particleSystem.createDeathExplosion({x:t,y:s},a.color,30),this.draw(),!0}return this.draw(),!1}getTowerAt(e,t){return this.towers.find(s=>s.gridRow===e&&s.gridCol===t)}togglePause(){this.isPaused?this.resumeGame():this.pauseGame()}pauseGame(){this.gameState==="playing"&&(this.isPaused=!0,this.updatePausePopup(),this.pauseOverlay.classList.remove("hidden"),this.pauseButton.textContent="â–¶ï¸",this.animationFrameId!==null&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null))}resumeGame(){this.isPaused&&(this.isPaused=!1,this.pauseOverlay.classList.add("hidden"),this.pauseButton.textContent="â¸ï¸",this.lastTime=performance.now(),this.gameLoop(this.lastTime))}updatePausePopup(){const e=document.getElementById("pause-wave"),t=document.getElementById("pause-tokens"),s=document.getElementById("pause-kills"),i=document.getElementById("pause-towers"),a=document.getElementById("pause-hp"),n=document.getElementById("pause-time");if(e&&(e.textContent=String(this.waveNumber)),t&&(t.textContent=String(this.totalTokensEarnedThisGame)),s&&(s.textContent=String(this.totalEnemiesKilledThisGame)),i&&(i.textContent=String(this.towers.filter(o=>o.isAlive).length)),a&&(a.textContent=`${this.baseHP}/${this.maxBaseHP}`),n){const o=Math.floor((Date.now()-this.gameStartTime)/1e3),l=Math.floor(o/60),h=o%60;n.textContent=`${l}:${h.toString().padStart(2,"0")}`}}returnToTitle(){this.isPaused=!1,this.pauseOverlay.classList.add("hidden"),this.pauseButton.textContent="â¸ï¸",this.animationFrameId!==null&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null),this.gameState="idle",this.sceneManager.changeScene("title"),this.titleScreen.show()}startWave(){this.sceneManager.isGameScene()&&this.gameState!=="playing"&&(this.gameState="playing",this.enemiesSpawned=0,this.lastSpawnTime=0,this.startButton.disabled=!0,this.startButton.textContent="Wave in Progress...",this.isBossWave=this.waveNumber%10===0,this.bossSpawned=!1,this.isBossWave&&(this.showBossWarning=!0,this.bossWarningStartTime=performance.now(),this.startButton.textContent="âš ï¸ BOSS WAVE âš ï¸"),this.enemiesPerWave=12+this.waveNumber*4,this.enemiesKilledThisWave=0,this.lastCardRefillKillCount=0,this.spellSystem.resetUsageCounts(),this.lastTime=performance.now(),this.gameLoop(this.lastTime))}gameLoop(e){if(!this.isPaused){if(this.baseHP<=0){this.gameOver();return}if(this.spawnEnemies(e),this.update(e),this.draw(),this.updateUI(),this.checkWaveComplete()){this.endWave();return}this.animationFrameId=requestAnimationFrame(t=>this.gameLoop(t))}}spawnEnemies(e){if(!(this.showBossWarning&&e-this.bossWarningStartTime<2e3)){if(this.showBossWarning&&e-this.bossWarningStartTime>=2e3&&(this.showBossWarning=!1),this.isBossWave&&!this.bossSpawned){this.spawnBoss(),this.bossSpawned=!0,this.lastSpawnTime=e;return}if(!(this.enemiesSpawned>=this.enemiesPerWave)&&e-this.lastSpawnTime>=this.spawnInterval){const t=this.pathSystem.getRandomRouteIndex(),s=this.pathSystem.getPath(t),i=this.selectEnemyType(),a=this.selectEnemyResistance(),n=new R(s,t,i,this.waveNumber,void 0,a);this.enemies.push(n),this.enemiesSpawned++,this.lastSpawnTime=e,this.encyclopediaManager.recordEnemyEncountered(i)}}}spawnBoss(){const e=this.pathSystem.getRandomRouteIndex(),t=this.pathSystem.getPath(e),s=new R(t,e,"boss",this.waveNumber,void 0,null);this.enemies.push(s),this.encyclopediaManager.recordEnemyEncountered("boss")}selectEnemyResistance(){if(this.waveNumber<5)return null;const e=Math.min(20,10+(this.waveNumber-5)*2);if(Math.random()*100<e){const t=["fire","ice","lightning"];return t[Math.floor(Math.random()*t.length)]}return null}selectEnemyType(){const e=Math.random()*100,t=Math.min(60,10+this.waveNumber*5);if(e<t){const s=["tank"];return this.waveNumber>=3&&s.push("breaker"),this.waveNumber>=5&&s.push("ghost"),s[Math.floor(Math.random()*s.length)]}return"normal"}update(e){const t=this.towers.filter(i=>i.isAlive);for(const i of this.enemies)if(i.isAlive){if(i.isBoss()&&i.canUseSkill(e)&&this.handleBossSkill(i,e,t),i.enemyType==="breaker"&&i.targetTower&&i.targetTower.isAlive){const n=i.targetTower,o=n.position.x-i.position.x,l=n.position.y-i.position.y;if(Math.sqrt(o*o+l*l)<i.size/2+n.size/2){const c=i.attackTower(n,e),d=n.takeDamage(c);this.particleSystem.createDeathExplosion(n.position,"#e67e22",30),this.damagePopupManager.createPopup(n.position,c,!0,"#e67e22"),d&&this.handleTowerDestruction(n);continue}}const a=i.update(t);if(a&&i.enemyType==="breaker"&&i.targetTower&&i.targetTower.isAlive){const n=i.targetTower,o=i.attackTower(n,e),l=n.takeDamage(o);this.particleSystem.createDeathExplosion(n.position,"#e67e22",30),this.damagePopupManager.createPopup(n.position,o,!0,"#e67e22"),l&&this.handleTowerDestruction(n)}else if(a){i.isAlive=!1,this.baseHP-=10;const n=this.pathSystem.getBasePosition();this.particleSystem.createHitEffect(n,"#ff0000",15),this.damagePopupManager.createPopup(n,10,!1,"#ff4444")}}this.processEnemyAttacks(e),this.enemies=this.enemies.filter(i=>i.isAlive);for(const i of this.towers)i.isAlive||this.gridSystem.releaseCell(i.gridRow,i.gridCol);this.towers=this.towers.filter(i=>i.isAlive),this.towers.some(i=>!i.isAlive)&&this.synergySystem.calculateAndApplySynergies(this.towers.filter(i=>i.isAlive));for(const i of this.towers){if(!i.isAlive)continue;i.findTarget(this.enemies);const a=i.tryFire(e);a&&this.projectiles.push(a)}for(const i of this.projectiles){const a=i.update();if(a&&a.hit){if(a.target.tryEvade()){this.damagePopupManager.createTextPopup(a.position,"MISS!","#aaaaaa");continue}const n=this.reactionSystem.checkAndTriggerReaction(a.target,a.element,a.damage,this.enemies);if(n)this.handleReaction(n,a.position);else{const o=a.target.takeDamage(a.damage,a.element),l=o<a.damage;this.settingsManager.isShowDamageNumbers()&&(l?this.damagePopupManager.createTextPopup(a.position,"RESIST!","#888888"):this.damagePopupManager.createPopup(a.position,o,a.isCritical,a.isCritical?"#ffd700":"#ffffff")),this.settingsManager.isShowParticles()&&this.particleSystem.createHitEffect(a.position,l?"#888888":i.color,a.isCritical?10:6)}if(!a.target.isAlive){if(this.settingsManager.isShowParticles()&&this.particleSystem.createDeathExplosion(a.position,a.targetColor,a.target.isBoss()?50:20),this.encyclopediaManager.recordEnemyDefeated(a.target.enemyType),a.target.isBoss())this.handleBossDefeat(a.position);else{const o=this.economyManager.tryEnemyDrop();o>0&&(this.totalTokensEarnedThisGame+=o,this.damagePopupManager.createTextPopup({x:a.position.x,y:a.position.y-20},`+${o}ðŸ’°`,"#f1c40f"))}this.onEnemyKilled()}}}this.projectiles=this.projectiles.filter(i=>i.isActive);const s=Date.now();this.activeSpellAnimations=this.activeSpellAnimations.filter(i=>s-i.startTime<i.duration),this.particleSystem.update(),this.damagePopupManager.update()}processEnemyAttacks(e){const{GRID_SIZE:t}=g;for(const s of this.enemies)if(s.isAlive&&s.enemyType!=="breaker"&&s.canAttackTower(e))for(const i of this.towers){if(!i.isAlive)continue;const a=i.position.x-s.position.x,n=i.position.y-s.position.y;if(Math.sqrt(a*a+n*n)<t*1.5){const l=s.attackTower(i,e),h=i.takeDamage(l);this.particleSystem.createHitEffect(i.position,"#ff6600",8),this.damagePopupManager.createPopup(i.position,l,!1,"#ff6600"),h&&this.handleTowerDestruction(i);break}}}handleTowerDestruction(e){this.particleSystem.createDeathExplosion(e.position,e.getElementConfig().color,25),this.gridSystem.releaseCell(e.gridRow,e.gridCol),this.synergySystem.calculateAndApplySynergies(this.towers.filter(t=>t.isAlive))}handleReaction(e,t){switch(this.damagePopupManager.createTextPopup({x:t.x,y:t.y-30},e.config.name,e.config.color),e.damage>0&&this.damagePopupManager.createPopup(t,e.damage,!0,e.config.color),e.type){case"melt":this.particleSystem.createDeathExplosion(t,"#ff9800",25);break;case"freeze":this.particleSystem.createHitEffect(t,"#00bcd4",20);break;case"explosion":this.particleSystem.createDeathExplosion(t,"#ff5722",40);for(const s of e.affectedEnemies)s.isAlive&&this.particleSystem.createHitEffect(s.getCenter(),"#ff5722",8);break}}checkWaveComplete(){return this.enemiesSpawned>=this.enemiesPerWave&&this.enemies.length===0}endWave(){this.animationFrameId!==null&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null);const e=this.economyManager.applyWaveClearBonus();this.totalTokensEarnedThisGame+=e.total,this.gameState="shop",this.startButton.disabled=!0,this.startButton.textContent="ã‚·ãƒ§ãƒƒãƒ—...";const t=this.economyManager.getShopExpansion(),s=this.economyManager.getRarityBonus(),i=this.shopManager.generateShopItems(this.waveNumber,t,s);this.shopUI.show(i,this.economyManager.getTokens(),e),this.draw(),this.updateUI()}gameOver(){this.gameState="gameover",this.animationFrameId!==null&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null);const e=Math.floor((Date.now()-this.gameStartTime)/1e3),t=this.calculateScore(),s=this.getMainTowers();this.encyclopediaManager.saveAll();const i=this.progressManager.addGameResult(this.waveNumber,this.totalEnemiesKilledThisGame,!1),a=Math.floor(this.totalTokensEarnedThisGame*.5);this.progressManager.addPermanentTokens(a),this.progressManager.addMatchHistory({date:new Date().toISOString(),waveReached:this.waveNumber,enemiesKilled:this.totalEnemiesKilledThisGame,tokensEarned:this.totalTokensEarnedThisGame,xpEarned:i.xpGained,score:t,mainTowers:s,duration:e}),this.startButton.disabled=!1,this.startButton.textContent="ã‚¿ã‚¤ãƒˆãƒ«ã«æˆ»ã‚‹";const n=()=>{this.startButton.removeEventListener("click",n),this.returnToTitle()};this.startButton.addEventListener("click",n),this.draw(),this.drawGameOverScreen(i)}drawGameOverScreen(e){const{CANVAS_WIDTH:t,CANVAS_HEIGHT:s}=g,i=t/2,a=Math.floor(this.totalTokensEarnedThisGame*.5),n=this.calculateScore();this.ctx.fillStyle="rgba(0, 0, 0, 0.85)",this.ctx.fillRect(0,0,t,s),this.ctx.font="bold 42px sans-serif",this.ctx.fillStyle="#e74c3c",this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText("GAME OVER",i,60),this.ctx.font="20px sans-serif",this.ctx.fillStyle="#fff",this.ctx.fillText(`Wave ${this.waveNumber} ã¾ã§åˆ°é”`,i,110),this.ctx.font="16px sans-serif",this.ctx.fillStyle="#aaa",this.ctx.fillText(`æ’ƒç ´æ•°: ${this.totalEnemiesKilledThisGame}  |  ã‚¹ã‚³ã‚¢: ${n.toLocaleString()}`,i,140);let o=180;this.ctx.font="bold 20px sans-serif",this.ctx.fillStyle="#ffd700",this.ctx.fillText(`+${e.xpGained} XP`,i-60,o),this.ctx.fillStyle="#f1c40f",this.ctx.fillText(`+${a} ðŸ’°`,i+60,o),e.rankUp&&(o+=50,this.ctx.font="bold 24px sans-serif",this.ctx.fillStyle="#2ecc71",this.ctx.fillText(`ðŸŽ‰ RANK UP! â†’ Rank ${e.newRank}`,i,o),e.newUnlocks.length>0&&(o+=35,this.ctx.font="14px sans-serif",this.ctx.fillStyle="#ffd700",this.ctx.fillText("æ–°ã—ãã‚¢ãƒ³ãƒ­ãƒƒã‚¯:",i,o),e.newUnlocks.forEach((h,c)=>{this.ctx.fillText(`${h.icon} ${h.name}`,i,o+25+c*22)})));const l=this.getMainTowers();if(l.length>0){this.ctx.font="14px sans-serif",this.ctx.fillStyle="#888",this.ctx.fillText("ãƒ¡ã‚¤ãƒ³ã‚¿ãƒ¯ãƒ¼:",i,s-100),this.ctx.font="28px sans-serif";const h=l.map(c=>this.getElementIcon(c)).join(" ");this.ctx.fillText(h,i,s-70)}this.ctx.font="14px sans-serif",this.ctx.fillStyle="#888",this.ctx.fillText("ã‚¯ãƒªãƒƒã‚¯ã§ã‚¿ã‚¤ãƒˆãƒ«ã«æˆ»ã‚‹",i,s-30)}calculateScore(){const e=this.waveNumber*1e3,t=this.totalEnemiesKilledThisGame*50,s=this.totalTokensEarnedThisGame*10,i=this.towers.length*100;return e+t+s+i}getMainTowers(){return[...this.towerUsageCount.entries()].sort((t,s)=>s[1]-t[1]).slice(0,3).map(([t])=>t)}draw(){const{CANVAS_WIDTH:e,CANVAS_HEIGHT:t,BACKGROUND_COLOR:s}=g;this.ctx.fillStyle=s,this.ctx.fillRect(0,0,e,t),this.gridSystem.draw(this.ctx),this.pathSystem.draw(this.ctx),this.hoverCell&&this.drawHoverCellWithMergePreview();for(const i of this.towers)i.draw(this.ctx,!0);for(const i of this.enemies)i.draw(this.ctx);for(const i of this.projectiles)i.draw(this.ctx);this.drawSpellEffects(),this.particleSystem.draw(this.ctx),this.damagePopupManager.draw(this.ctx),this.draggingCard&&this.dragPosition&&this.drawDragPreview(),this.gameState==="shop"&&this.shopUI.draw(this.ctx,S.SHOP_REROLL_COST,this.shopManager.getRerollTokens()),this.showBossWarning&&this.drawBossWarning()}drawBossWarning(){const{CANVAS_WIDTH:e,CANVAS_HEIGHT:t}=g,s=performance.now()-this.bossWarningStartTime;if(s>2e3)return;const i=Math.sin(s/100)*.3+.3;this.ctx.fillStyle=`rgba(192, 57, 43, ${i})`,this.ctx.fillRect(0,0,e,t);const a=e/2,n=t/2;this.ctx.fillStyle="rgba(0, 0, 0, 0.8)",this.ctx.fillRect(a-200,n-60,400,120),this.ctx.strokeStyle="#c0392b",this.ctx.lineWidth=4,this.ctx.strokeRect(a-200,n-60,400,120),Math.floor(s/300)%2===0&&(this.ctx.font="bold 36px sans-serif",this.ctx.fillStyle="#e74c3c",this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText("âš ï¸ WARNING âš ï¸",a,n-20)),this.ctx.font="bold 24px sans-serif",this.ctx.fillStyle="#ffd700",this.ctx.fillText("BOSS APPROACHING",a,n+25)}drawSpellEffects(){const e=Date.now();for(const t of this.activeSpellAnimations){const s=e-t.startTime,i=Math.min(1,s/t.duration);this.spellSystem.drawSpellEffect(this.ctx,t.spellType,t.position,i)}}drawHoverCellWithMergePreview(){var i;if(!this.hoverCell)return;const{row:e,col:t}=this.hoverCell,s=this.getTowerAt(e,t);if(s&&this.draggingCard&&this.draggingCard.isTowerCard())if(this.draggingCard.element&&s.canMergeWith(this.draggingCard.element,1)){const{GRID_SIZE:n}=g;this.ctx.fillStyle="rgba(255, 215, 0, 0.4)",this.ctx.fillRect(t*n,e*n,n,n),this.ctx.strokeStyle="#ffd700",this.ctx.lineWidth=3,this.ctx.strokeRect(t*n,e*n,n,n),this.ctx.font="bold 12px sans-serif",this.ctx.fillStyle="#ffd700",this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText("Lv UP!",t*n+n/2,e*n+n-8)}else this.gridSystem.drawHoverCell(this.ctx,e,t);else(i=this.draggingCard)!=null&&i.isSpellCard()||this.gridSystem.drawHoverCell(this.ctx,e,t)}drawDragPreview(){if(!this.draggingCard||!this.dragPosition)return;if(this.draggingCard.isSpellCard()&&this.draggingCard.spellType){this.spellSystem.drawSpellPreview(this.ctx,this.draggingCard.spellType,this.dragPosition);return}if(!this.draggingCard.isTowerCard()||!this.hoverCell)return;const{row:e,col:t}=this.hoverCell;if(this.getTowerAt(e,t)||!this.gridSystem.canPlaceTower(e,t))return;const a=this.gridSystem.getCellCenter(e,t),n=this.draggingCard.getElementConfig();if(!n)return;const o=30,l=o/2;this.ctx.globalAlpha=.6,this.ctx.fillStyle=n.color,this.ctx.fillRect(a.x-l,a.y-l,o,o),this.ctx.strokeStyle=n.borderColor,this.ctx.lineWidth=2,this.ctx.strokeRect(a.x-l,a.y-l,o,o),this.ctx.beginPath(),this.ctx.arc(a.x,a.y,120,0,Math.PI*2),this.ctx.fillStyle=`${n.color}30`,this.ctx.fill(),this.ctx.globalAlpha=1,this.draggingCard.element&&this.settingsManager.isShowSynergyPreview()&&this.drawSynergyPreview(e,t,this.draggingCard.element)}drawSynergyPreview(e,t,s){const i=this.synergySystem.previewSynergies(s,e,t,this.towers);if(i.newTowerSynergies.length>0){const a=this.gridSystem.getCellCenter(e,t);this.ctx.font="bold 10px sans-serif",this.ctx.fillStyle="#ffd700",this.ctx.textAlign="center";const n=i.newTowerSynergies.map(o=>o.icon).join("");this.ctx.fillText(n,a.x,a.y-25)}for(const{tower:a,newSynergies:n}of i.affectedTowers)if(n.length>a.activeSynergies.length){const{GRID_SIZE:o}=g;this.ctx.strokeStyle="rgba(255, 215, 0, 0.7)",this.ctx.lineWidth=2,this.ctx.setLineDash([4,4]),this.ctx.strokeRect(a.gridCol*o+2,a.gridRow*o+2,o-4,o-4),this.ctx.setLineDash([])}}updateUI(){this.waveCountElement.textContent=String(this.waveNumber),this.enemyCountElement.textContent=String(this.enemies.length),this.towerCountElement.textContent=String(this.towers.length),this.baseHPElement&&(this.baseHPElement.textContent=String(Math.max(0,this.baseHP)),this.baseHP<=30?this.baseHPElement.style.color="#e74c3c":this.baseHP<=60?this.baseHPElement.style.color="#f39c12":this.baseHPElement.style.color="#2ecc71"),this.tokenDisplayElement&&(this.tokenDisplayElement.textContent=String(this.economyManager.getTokens())),this.updateSynergyDisplay(),this.updateDeckDisplay()}updateSynergyDisplay(){if(!this.synergyListElement)return;const e=this.synergySystem.getActiveSynergySummary(this.towers);if(e.size===0){this.synergyListElement.innerHTML='<span class="no-synergy">ãªã—</span>';return}const t=[];e.forEach((s,i)=>{t.push(`<span class="synergy-item">${i} Ã—${s}</span>`)}),this.synergyListElement.innerHTML=t.join("")}updateDeckDisplay(){if(this.deckTotalElement&&(this.deckTotalElement.textContent=String(this.deckManager.getTotalCardCount())),this.upgradeListElement){const e=this.deckManager.getUpgrades(),t=[];for(const[s,i]of Object.entries(e.damageBonus))if(i>1){const a=s==="fire"?"ðŸ”¥":s==="ice"?"â„ï¸":"âš¡";t.push(`${a} +${Math.round((i-1)*100)}%`)}e.allDamageBonus>1&&t.push(`âš”ï¸ å…¨ä½“ +${Math.round((e.allDamageBonus-1)*100)}%`),e.fireRateBonus<1&&t.push(`âš¡ é€Ÿåº¦ +${Math.round((1-e.fireRateBonus)*100)}%`),e.rangeBonus>0&&t.push(`ðŸŽ¯ å°„ç¨‹ +${e.rangeBonus}`),t.length===0?this.upgradeListElement.innerHTML='<span style="color: #555;">ãªã—</span>':this.upgradeListElement.innerHTML=t.map(s=>`<div style="margin-bottom: 2px; color: #2ecc71;">${s}</div>`).join("")}}}const W=()=>{const p=document.getElementById("game-canvas");if(!p){console.error("Canvasè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");return}const e=new be(p);window.game=e,console.log("ðŸŽ® Elemental Deck Defense ãŒèµ·å‹•ã—ã¾ã—ãŸ")};document.readyState==="loading"?document.addEventListener("DOMContentLoaded",W):W();
